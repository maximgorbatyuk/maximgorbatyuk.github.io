<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A little life hack when you work with Azure Service Bus and ASP.NET Core | Maxim Gorbatyuk blog</title><meta name=keywords content=".net,tutorial,azure,asp.net,service bus"><meta name=description content="If you work with Azure infrastructure and have to integrate message queues. It sounds quite simple: just create Azure Resource, write some code and then be happy! But what would you say if the resources are limited? What will you do if there are several teammates in your team, and all of you have to debug queues at the same time?
Well, I know a minor life hack for my teams."><meta name=author content="Maxim Gorbatyuk"><link rel=canonical href=https://maximgorbatyuk.github.io/blog/development/2021-03-07-asp-net-azure-sb-queues/><link crossorigin=anonymous href=/assets/css/stylesheet.min.73c36c7f05ec14bbac8d41fef9d3d1d7a0fbf26da432df6ab8fa2a59e6bb393b.css integrity="sha256-c8NsfwXsFLusjUH++dPR16D78m2kMt9quPoqWea7OTs=" rel="preload stylesheet" as=style><link rel=preload href=/images/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://maximgorbatyuk.github.io/images/avatar.png><link rel=icon type=image/png sizes=16x16 href=https://maximgorbatyuk.github.io/images/avatar.png><link rel=icon type=image/png sizes=32x32 href=https://maximgorbatyuk.github.io/images/avatar.png><link rel=apple-touch-icon href=https://maximgorbatyuk.github.io/images/avatar.png><link rel=mask-icon href=https://maximgorbatyuk.github.io/images/avatar.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-86410344-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="A little life hack when you work with Azure Service Bus and ASP.NET Core"><meta property="og:description" content="If you work with Azure infrastructure and have to integrate message queues. It sounds quite simple: just create Azure Resource, write some code and then be happy! But what would you say if the resources are limited? What will you do if there are several teammates in your team, and all of you have to debug queues at the same time?
Well, I know a minor life hack for my teams."><meta property="og:type" content="article"><meta property="og:url" content="https://maximgorbatyuk.github.io/blog/development/2021-03-07-asp-net-azure-sb-queues/"><meta property="og:image" content="https://maximgorbatyuk.github.io/images/avatar.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-03-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-07T00:00:00+00:00"><meta property="og:site_name" content="Maxim Gorbatyuk blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maximgorbatyuk.github.io/images/avatar.png"><meta name=twitter:title content="A little life hack when you work with Azure Service Bus and ASP.NET Core"><meta name=twitter:description content="If you work with Azure infrastructure and have to integrate message queues. It sounds quite simple: just create Azure Resource, write some code and then be happy! But what would you say if the resources are limited? What will you do if there are several teammates in your team, and all of you have to debug queues at the same time?
Well, I know a minor life hack for my teams."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://maximgorbatyuk.github.io/blog/"},{"@type":"ListItem","position":2,"name":"A little life hack when you work with Azure Service Bus and ASP.NET Core","item":"https://maximgorbatyuk.github.io/blog/development/2021-03-07-asp-net-azure-sb-queues/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A little life hack when you work with Azure Service Bus and ASP.NET Core","name":"A little life hack when you work with Azure Service Bus and ASP.NET Core","description":"If you work with Azure infrastructure and have to integrate message queues. It sounds quite simple: just create Azure Resource, write some code and then be happy! But what would you say if the resources are limited? What will you do if there are several teammates in your team, and all of you have to debug queues at the same time?\nWell, I know a minor life hack for my teams.","keywords":[".net","tutorial","azure","asp.net","service bus"],"articleBody":"If you work with Azure infrastructure and have to integrate message queues. It sounds quite simple: just create Azure Resource, write some code and then be happy! But what would you say if the resources are limited? What will you do if there are several teammates in your team, and all of you have to debug queues at the same time?\nWell, I know a minor life hack for my teams. I create an InMemory Message queue engine for local development and use Azure Service Bus (or any other external MQ engine) only for remote environments. This solution allows me to not think about paid resources or concurrency access to the single development queue.\nDevelopers just create business logic and do not care about Azure Access or availability. I think the InMemory engine should not become an issue. Most of the business tasks do not depend on the technical implementation of the queue engine. My opinion that they should not do it at all. When you have to develop a technical algorithm that uses, for example, some Kafka or RabbitMQ features, you will debug it using external resources. But in my opinion, business logic should not depend on either RabbitMQ or Kafka, or Azure Service Bus. When you write unites, you do the same, aren’t you? Therefore the logic can use the InMemory solution during the local development.\nSo, let me show my solution. If you meet a similar task, the solution could be helpful for you. As an example, I will use an email distribution service (EDS) that accepts emails via Queues and then sends them. My apps publish email content, my EDS consumes it and sends using the SMTP server.\nTherefore, we need to develop the following items:\nSettings for our application Queue message publisher Queue consumer. Using InMemory Queues engine InMemory Setup I will use the MassTransit library to make the solution simpler. Here is a code that sets the MassTransit:\n// IServiceCollection services; services.AddMassTransit(x =\u003e { x.AddConsumer(); x.UsingInMemory((context, cfg) =\u003e { cfg.TransportConcurrencyLimit = 100; cfg.ConfigureEndpoints(context); cfg.ReceiveEndpoint(_configuration.EmailMessageTopic.ToString(), e =\u003e { e.ConfigureConsumer(context); }); }); }); services.AddMassTransitHostedService(); services.AddScoped(); Here I use some config values. The class represents MQ settings and is used by both queues: InMemory and Azure Service Bus.\nusing Microsoft.Extensions.Configuration; namespace YourNamespace { public class MessageBrokerSettings { public NonNullableString Connection { get; } public NonNullableString EmailMessageTopic { get; } public NonNullableString HealthCheckConnection { get; } public NonNullableString HealthCheckTopic { get; } public MessageBrokerSettings(IConfiguration configuration) { var section = configuration.GetSection(\"Azure\").GetSection(\"ServiceBus\"); Connection = new NonNullableString(section[nameof(Connection)]); EmailMessageTopic = new NonNullableString(section[nameof(EmailMessageTopic)]); HealthCheckConnection = new NonNullableString(section[nameof(HealthCheckConnection)]); HealthCheckTopic = new NonNullableString(section[nameof(HealthCheckTopic)]); } } } NonNullableString is a special class that makes me sure that the value inside will never be null. Some kind of ValueObject from DDD, you know. When I invoke .ToString() method, the class returns me a value of the config. Otherwise, it will throw an exception. The code of the class you may see at my GitHub gist: NonNullableString.cs.\nInMemory Publisher Now we have created a publisher and consumer. The email publisher will use IPublishEnpoint that is given us by MassTransit library:\nusing System.Threading.Tasks; using MassTransit; using Microsoft.Extensions.Logging; namespace YourNamespace { public class InMemoryBrokerPublisher : BrokerPublisherBase { private readonly IPublishEndpoint _publish; public InMemoryBrokerPublisher(IPublishEndpoint publish, ILogger logger) : base(logger) { _publish = publish; } protected override Task PublishInternalAsync(string topicName, T message) { return _publish.Publish(message); } } } The BrokerPublisherBase is a base class and does not depend on queue implementation. The class is inherited by both queue-related publishers as well. It implements a simple IMessageBroker.\nusing System.Threading.Tasks; namespace YourNamespace { public interface IMessageBroker { Task PublishAsync(string topicName, T message) where T : class; } } This interface gives the other business logic an endpoint to publish any message.\nInMemory Consumer We will use MassTransit’s ConsumerBase interface for InMemory consumers. Here is a content of the MassTransitEmailSendConsumer:\nusing System.Threading.Tasks; using MassTransit; using Microsoft.Extensions.Logging; namespace YourNamespace { public class MassTransitEmailSendConsumer : ConsumerBase { private readonly IEmail _email; protected override async Task ConsumeAsync(ConsumeContext context) { await _email.SendAsync(context.Message); Logger.LogDebug(“Email sent”); } public MassTransitEmailSendConsumer(ILogger logger, IEmail email) : base(logger) { _email = email; } } } IEmail is my business logic interface who is responsible for sending emails. The content of the class does not related to the article subject, and that’s why I don’t give a content of the class. The MassTransitEmailSendConsumer inherits from my own ConsumerBase.cs class implementing MassTransit’s IConsumer.\nNow our ASP.NET core app could work with Message Queues using only memory. Let’s continue with Azure services.\nUsing Azure Service Bus queues I will not tell you about how to create an Azure Service Bus (ASB) using portal.azure.com. Here is a tutorial made by Microsoft. Let’s assume that we have already got a connection string of the Service Bus. How to get it, please read the tutorial from the MS above.\nI have created one queue for emailing and a special topic for azure health check. If you don’t need the health-check, you may create only needed queues.\nAzure SB Setup First, we should set up our application to work with the ASB.\n// IServiceCollection services; // MessageBrokerSettings configuration; services.AddHostedService(); services.AddScoped(); services .AddHealthChecks() .AddAzureServiceBusTopic( connectionString: configuration.HealthCheckConnection.ToString(), topicName: configuration.HealthCheckTopic.ToString()); My app’s appsettings.json file contains the following values:\n“MessageBroker”: { “Connection”: “Endpoint=sb://yournamespace.windows.net/;SharedAccessKeyName=email;SharedAccessKey=awesomesecret”, “EmailMessageTopic”: “email-message-queue”, “HealthCheckConnection”: “Endpoint=sb://yournamespace.windows.net/;SharedAccessKeyName=healthcheck;SharedAccessKey=awesomesecret”, “HealthCheckTopic”: “azuretopic” }, “UseInMemoryMessageBroker”: true, MessageBroker section is being used by MessageBrokerSettings class. azuretopic value is a service name of the topic and is used by Health-check library.\nAzure SB Publisher The ASB accepts a string as the queue message, therefore we have to serialize a message. I use JSON format for the serialization. Here is a code of my publisher:\nusing System.Threading.Tasks; using Azure.Messaging.ServiceBus; using Microsoft.Extensions.Logging; using Newtonsoft.Json; using Services.Infrastructure.Azure; namespace YourNamespace { public class AzureServiceBusPublisher : BrokerPublisherBase { private readonly MessageBrokerSettings _config; public AzureServiceBusPublisher(MessageBrokerSettings configuration, ILogger logger) : base(logger) { _config = configuration; } protected override async Task PublishInternalAsync(string topicName, T message) { // create a Service Bus client await using var client = new ServiceBusClient(_config.Connection.ToString()); ServiceBusSender sender = client.CreateSender(topicName); // create a message that we can send // send the message await sender.SendMessageAsync( new ServiceBusMessage(JsonConvert.SerializeObject(message))); } } } Please pay attention that the class above uses BrokerPublisherBase as parent. We create ServiceBusClient for each invocation of the class, and this way is recommended by Microsoft.\nAzure SB Consumer Consuming the SB queue message is not as simple as publishing. We should create a hosted service to consume messages within the background process of the ASP.NET Core app. We will use a BackgroundService provided by .net library. We will setup Callbacks for messages and possible errors, and then we will start an endless loop to make the background service working during the main app execution.\nusing System; using System.Threading.Tasks; using Azure.Messaging.ServiceBus; using Microsoft.Extensions.DependencyInjection; using Microsoft.Extensions.Logging; namespace YourNamespace { public class AzureBrokerEmailConsumerBackService : AzureBusTopicConsumerBase { public AzureBrokerEmailConsumerBackService( ILogger logger, IServiceScopeFactory scopeFactory, MessageBrokerSettings brokerSettings) : base( logger, scopeFactory, brokerSettings) { } // handle received messages protected override NonNullableString MessageTopic =\u003e BrokerSettings.EmailMessageTopic; protected override Task MessageHandleInternalAsync(IServiceProvider provider, ServiceBusReceivedMessage message) { string body = message.Body.ToString(); var email = provider.GetRequiredService(); return email.SendAsync(body); } } } The consumer above inherits from our special class AzureBusTopicConsumerBase. This class hides most of the code that sets up the background service. Also, the class creates scope for each received message and then provides an instance of IServiceProvider provider. The provider is useful to get any business service to execute your task:\nusing var scope = ScopeFactory.CreateScope(); await MessageHandleInternalAsync(scope.ServiceProvider, args.Message); // complete the message. messages is deleted from the queue. await args.CompleteMessageAsync(args.Message); Conclusion All you need is a config class that will decide what MQ engine will be used for the running application: the InMemory MQ engine either Azure Service Bus. I have created a helper-class for this purpose, so you can use it as well. Now you have an application that uses Azure Service Bus for staging and production environments and InMemory engine for the local development.\nHope my article was useful for you. Thank you for the reading!\n","wordCount":"1325","inLanguage":"en","datePublished":"2021-03-07T00:00:00Z","dateModified":"2021-03-07T00:00:00Z","author":{"@type":"Person","name":"Maxim Gorbatyuk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://maximgorbatyuk.github.io/blog/development/2021-03-07-asp-net-azure-sb-queues/"},"publisher":{"@type":"Organization","name":"Maxim Gorbatyuk blog","logo":{"@type":"ImageObject","url":"https://maximgorbatyuk.github.io/images/avatar.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://maximgorbatyuk.github.io/ accesskey=h title="Maxim's blog (Alt + H)"><img src=https://maximgorbatyuk.github.io/images/avatar.png alt=logo aria-label=logo height=35>Maxim's blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://maximgorbatyuk.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://maximgorbatyuk.github.io/about/ title="About me"><span>About me</span></a></li><li><a href=https://maximgorbatyuk.github.io/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://maximgorbatyuk.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://maximgorbatyuk.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://maximgorbatyuk.notion.site/maximgorbatyuk/Knowledge-base-f87dcc7b0e98498499cfd606d06bd0c7 title=KB><span>KB</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>A little life hack when you work with Azure Service Bus and ASP.NET Core</h1><div class=post-meta><span title='2021-03-07 00:00:00 +0000 UTC'>March 7, 2021</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Maxim Gorbatyuk</div></header><div class=post-content><p>If you work with Azure infrastructure and have to integrate message queues. It sounds quite simple: just create Azure Resource, write some code and then be happy! But what would you say if the resources are limited? What will you do if there are several teammates in your team, and all of you have to debug queues at the same time?</p><p>Well, I know a minor life hack for my teams. I create an InMemory Message queue engine for local development and use Azure Service Bus (or any other external MQ engine) only for remote environments. This solution allows me to not think about paid resources or concurrency access to the single development queue.</p><p>Developers just create business logic and do not care about Azure Access or availability. I think the InMemory engine should not become an issue. Most of the business tasks do not depend on the technical implementation of the queue engine. My opinion that they should not do it at all. When you have to develop a technical algorithm that uses, for example, some Kafka or RabbitMQ features, you will debug it using external resources. But in my opinion, business logic should not depend on either RabbitMQ or Kafka, or Azure Service Bus. When you write unites, you do the same, aren’t you? Therefore the logic can use the InMemory solution during the local development.</p><p>So, let me show my solution. If you meet a similar task, the solution could be helpful for you. As an example, I will use an email distribution service (EDS) that accepts emails via Queues and then sends them. My apps publish email content, my EDS consumes it and sends using the SMTP server.</p><p>Therefore, we need to develop the following items:</p><ol><li>Settings for our application</li><li>Queue message publisher</li><li>Queue consumer.</li></ol><h2 id=using-inmemory-queues-engine>Using InMemory Queues engine<a hidden class=anchor aria-hidden=true href=#using-inmemory-queues-engine>#</a></h2><h3 id=inmemory-setup>InMemory Setup<a hidden class=anchor aria-hidden=true href=#inmemory-setup>#</a></h3><p>I will use the <a href=https://masstransit-project.com>MassTransit</a> library to make the solution simpler. Here is a code that sets the MassTransit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// IServiceCollection services;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.AddMassTransit(x =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    x.AddConsumer&lt;MassTransitEmailSendConsumer&gt;();
</span></span><span style=display:flex><span>    x.UsingInMemory((context, cfg) =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        cfg.TransportConcurrencyLimit = <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>        cfg.ConfigureEndpoints(context);
</span></span><span style=display:flex><span>        cfg.ReceiveEndpoint(<span style=color:#ae81ff>_</span>configuration.EmailMessageTopic.ToString(), e =&gt;
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            e.ConfigureConsumer&lt;MassTransitEmailSendConsumer&gt;(context);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.AddMassTransitHostedService();
</span></span><span style=display:flex><span>services.AddScoped&lt;IMessageBroker, InMemoryBrokerPublisher&gt;();
</span></span></code></pre></div><p>Here I use some config values. The class represents MQ settings and is used by both queues: InMemory and Azure Service Bus.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> YourNamespace
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MessageBrokerSettings</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> NonNullableString Connection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> NonNullableString EmailMessageTopic { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> NonNullableString HealthCheckConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> NonNullableString HealthCheckTopic { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> MessageBrokerSettings(IConfiguration configuration)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> section = configuration.GetSection(<span style=color:#e6db74>&#34;Azure&#34;</span>).GetSection(<span style=color:#e6db74>&#34;ServiceBus&#34;</span>);
</span></span><span style=display:flex><span>            Connection = <span style=color:#66d9ef>new</span> NonNullableString(section[nameof(Connection)]);
</span></span><span style=display:flex><span>            EmailMessageTopic = <span style=color:#66d9ef>new</span> NonNullableString(section[nameof(EmailMessageTopic)]);
</span></span><span style=display:flex><span>            HealthCheckConnection = <span style=color:#66d9ef>new</span> NonNullableString(section[nameof(HealthCheckConnection)]);
</span></span><span style=display:flex><span>            HealthCheckTopic = <span style=color:#66d9ef>new</span> NonNullableString(section[nameof(HealthCheckTopic)]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>NonNullableString</code> is a special class that makes me sure that the value inside will never be null. Some kind of ValueObject from DDD, you know. When I invoke <code>.ToString()</code> method, the class returns me a value of the config. Otherwise, it will throw an exception. The code of the class you may see at my GitHub gist: <a href=https://gist.github.com/maximgorbatyuk/b772cb40d5bea823be8dc828e7e4ac27#file-nonnullablestring-cs>NonNullableString.cs</a>.</p><h3 id=inmemory-publisher>InMemory Publisher<a hidden class=anchor aria-hidden=true href=#inmemory-publisher>#</a></h3><p>Now we have created a publisher and consumer. The email publisher will use <code>IPublishEnpoint</code> that is given us by MassTransit library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> MassTransit;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> YourNamespace
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InMemoryBrokerPublisher</span> : BrokerPublisherBase
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IPublishEndpoint <span style=color:#ae81ff>_</span>publish;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> InMemoryBrokerPublisher(IPublishEndpoint publish, ILogger&lt;InMemoryBrokerPublisher&gt; logger)
</span></span><span style=display:flex><span>            : <span style=color:#66d9ef>base</span>(logger)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>_</span>publish = publish;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Task PublishInternalAsync&lt;T&gt;(<span style=color:#66d9ef>string</span> topicName, T message)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>_</span>publish.Publish(message);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <a href=https://gist.github.com/maximgorbatyuk/b772cb40d5bea823be8dc828e7e4ac27#file-brokerpublisherbase-cs>BrokerPublisherBase</a> is a base class and does not depend on queue implementation. The class is inherited by both queue-related publishers as well. It implements a simple IMessageBroker.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> YourNamespace
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IMessageBroker</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Task PublishAsync&lt;T&gt;(<span style=color:#66d9ef>string</span> topicName, T message)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>where</span> T : class;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This interface gives the other business logic an endpoint to publish any message.</p><h3 id=inmemory-consumer>InMemory Consumer<a hidden class=anchor aria-hidden=true href=#inmemory-consumer>#</a></h3><p>We will use MassTransit’s ConsumerBase interface for InMemory consumers. Here is a content of the <code>MassTransitEmailSendConsumer</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> MassTransit;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> YourNamespace
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MassTransitEmailSendConsumer</span> : ConsumerBase&lt;EmailMessage&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IEmail <span style=color:#ae81ff>_</span>email;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>async</span> Task ConsumeAsync(ConsumeContext&lt;EmailMessage&gt; context)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>email.SendAsync(context.Message);
</span></span><span style=display:flex><span>            Logger.LogDebug(<span style=color:#960050;background-color:#1e0010>“</span>Email sent<span style=color:#960050;background-color:#1e0010>”</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> MassTransitEmailSendConsumer(ILogger&lt;MassTransitEmailSendConsumer&gt; logger, IEmail email)
</span></span><span style=display:flex><span>            : <span style=color:#66d9ef>base</span>(logger)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>_</span>email = email;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>IEmail</code> is my business logic interface who is responsible for sending emails. The content of the class does not related to the article subject, and that’s why I don’t give a content of the class. The <code>MassTransitEmailSendConsumer</code> inherits from my own <a href=https://gist.github.com/maximgorbatyuk/b772cb40d5bea823be8dc828e7e4ac27#file-consumerbase-cs>ConsumerBase.cs</a> class implementing MassTransit’s <code>IConsumer&lt;T></code>.</p><p>Now our ASP.NET core app could work with Message Queues using only memory. Let’s continue with Azure services.</p><h2 id=using-azure-service-bus-queues>Using Azure Service Bus queues<a hidden class=anchor aria-hidden=true href=#using-azure-service-bus-queues>#</a></h2><p>I will not tell you about how to create an Azure Service Bus (ASB) using portal.azure.com. Here is a <a href=https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-create-namespace-portal>tutorial</a> made by Microsoft. Let’s assume that we have already got a connection string of the Service Bus. How to get it, please read the tutorial from the MS above.</p><p>I have created one queue for emailing and a special topic for azure health check. If you don’t need the health-check, you may create only needed queues.</p><h3 id=azure-sb-setup>Azure SB Setup<a hidden class=anchor aria-hidden=true href=#azure-sb-setup>#</a></h3><p>First, we should set up our application to work with the ASB.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// IServiceCollection services;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MessageBrokerSettings configuration;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.AddHostedService&lt;AzureBrokerEmailConsumerBackService&gt;();
</span></span><span style=display:flex><span>services.AddScoped&lt;IMessageBroker, AzureServiceBusPublisher&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services
</span></span><span style=display:flex><span>	.AddHealthChecks()
</span></span><span style=display:flex><span>	.AddAzureServiceBusTopic(
</span></span><span style=display:flex><span>		connectionString: configuration.HealthCheckConnection.ToString(),
</span></span><span style=display:flex><span>		topicName: configuration.HealthCheckTopic.ToString());
</span></span></code></pre></div><p>My app’s <code>appsettings.json</code> file contains the following values:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>“MessageBroker”:</span> {
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>“Connection”:</span> <span style=color:#960050;background-color:#1e0010>“Endpoint=sb:</span><span style=color:#75715e>//yournamespace.windows.net/;SharedAccessKeyName=email;SharedAccessKey=awesomesecret”,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#960050;background-color:#1e0010>“EmailMessageTopic”:</span> <span style=color:#960050;background-color:#1e0010>“email-message-queue”,</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>“HealthCheckConnection”:</span> <span style=color:#960050;background-color:#1e0010>“Endpoint=sb:</span><span style=color:#75715e>//yournamespace.windows.net/;SharedAccessKeyName=healthcheck;SharedAccessKey=awesomesecret”,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#960050;background-color:#1e0010>“HealthCheckTopic”:</span> <span style=color:#960050;background-color:#1e0010>“azuretopic”</span>
</span></span><span style=display:flex><span>}<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>“UseInMemoryMessageBroker”:</span> <span style=color:#66d9ef>true</span><span style=color:#960050;background-color:#1e0010>,</span>
</span></span></code></pre></div><p>MessageBroker section is being used by <code>MessageBrokerSettings</code> class. <code>azuretopic</code> value is a service name of the topic and is used by Health-check library.</p><h3 id=azure-sb-publisher>Azure SB Publisher<a hidden class=anchor aria-hidden=true href=#azure-sb-publisher>#</a></h3><p>The ASB accepts a string as the queue message, therefore we have to serialize a message. I use JSON format for the serialization. Here is a code of my publisher:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Azure.Messaging.ServiceBus;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Newtonsoft.Json;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Services.Infrastructure.Azure;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> YourNamespace
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AzureServiceBusPublisher</span> : BrokerPublisherBase
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> MessageBrokerSettings <span style=color:#ae81ff>_</span>config;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> AzureServiceBusPublisher(MessageBrokerSettings configuration, ILogger&lt;AzureServiceBusPublisher&gt; logger)
</span></span><span style=display:flex><span>            : <span style=color:#66d9ef>base</span>(logger)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>_</span>config = configuration;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>async</span> Task PublishInternalAsync&lt;T&gt;(<span style=color:#66d9ef>string</span> topicName, T message)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// create a Service Bus client</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>using</span> var client = <span style=color:#66d9ef>new</span> ServiceBusClient(<span style=color:#ae81ff>_</span>config.Connection.ToString());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ServiceBusSender sender = client.CreateSender(topicName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// create a message that we can send</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// send the message</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> sender.SendMessageAsync(
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> ServiceBusMessage(JsonConvert.SerializeObject(message)));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Please pay attention that the class above uses <a href=https://gist.github.com/maximgorbatyuk/b772cb40d5bea823be8dc828e7e4ac27#file-brokerpublisherbase-cs>BrokerPublisherBase</a> as parent. We create <code>ServiceBusClient</code> for each invocation of the class, and this way is <a href=https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dotnet-get-started-with-queues#add-code-to-send-messages-to-the-queue>recommended</a> by Microsoft.</p><h3 id=azure-sb-consumer>Azure SB Consumer<a hidden class=anchor aria-hidden=true href=#azure-sb-consumer>#</a></h3><p>Consuming the SB queue message is not as simple as publishing. We should create a hosted service to consume messages within the background process of the ASP.NET Core app. We will use a <code>BackgroundService</code> provided by .net library. We will setup Callbacks for messages and possible errors, and then we will start an endless loop to make the background service working during the main app execution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Azure.Messaging.ServiceBus;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.DependencyInjection;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> YourNamespace
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AzureBrokerEmailConsumerBackService</span> : AzureBusTopicConsumerBase
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> AzureBrokerEmailConsumerBackService(
</span></span><span style=display:flex><span>            ILogger&lt;AzureBrokerEmailConsumerBackService&gt; logger,
</span></span><span style=display:flex><span>            IServiceScopeFactory scopeFactory,
</span></span><span style=display:flex><span>            MessageBrokerSettings brokerSettings)
</span></span><span style=display:flex><span>            : <span style=color:#66d9ef>base</span>(
</span></span><span style=display:flex><span>                logger,
</span></span><span style=display:flex><span>                scopeFactory,
</span></span><span style=display:flex><span>                brokerSettings)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// handle received messages</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> NonNullableString MessageTopic =&gt; BrokerSettings.EmailMessageTopic;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Task MessageHandleInternalAsync(IServiceProvider provider, ServiceBusReceivedMessage message)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> body = message.Body.ToString();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> email = provider.GetRequiredService&lt;IEmail&gt;();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> email.SendAsync(body);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The consumer above inherits from our special class <a href=https://gist.github.com/maximgorbatyuk/b772cb40d5bea823be8dc828e7e4ac27#file-azurebustopicconsumerbase-cs>AzureBusTopicConsumerBase</a>. This class hides most of the code that sets up the background service. Also, the class creates scope for each received message and then provides an instance of <code>IServiceProvider provider</code>. The provider is useful to get any business service to execute your task:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> var scope = ScopeFactory.CreateScope();
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> MessageHandleInternalAsync(scope.ServiceProvider, args.Message);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// complete the message. messages is deleted from the queue.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> args.CompleteMessageAsync(args.Message);
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>All you need is a config class that will decide what MQ engine will be used for the running application: the InMemory MQ engine either Azure Service Bus. I have created <a href=https://gist.github.com/maximgorbatyuk/b772cb40d5bea823be8dc828e7e4ac27#file-messagebrokerconfig-cs>a helper-class</a> for this purpose, so you can use it as well. Now you have an application that uses Azure Service Bus for staging and production environments and InMemory engine for the local development.</p><p>Hope my article was useful for you. Thank you for the reading!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://maximgorbatyuk.github.io/tags/.net/>#.net</a></li><li><a href=https://maximgorbatyuk.github.io/tags/tutorial/>#tutorial</a></li><li><a href=https://maximgorbatyuk.github.io/tags/azure/>#azure</a></li><li><a href=https://maximgorbatyuk.github.io/tags/asp.net/>#asp.net</a></li><li><a href=https://maximgorbatyuk.github.io/tags/service-bus/>#service bus</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share A little life hack when you work with Azure Service Bus and ASP.NET Core on twitter" href="https://twitter.com/intent/tweet/?text=A%20little%20life%20hack%20when%20you%20work%20with%20Azure%20Service%20Bus%20and%20ASP.NET%20Core&url=https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f&hashtags=.net%2ctutorial%2cazure%2casp.net%2cservicebus"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share A little life hack when you work with Azure Service Bus and ASP.NET Core on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f&title=A%20little%20life%20hack%20when%20you%20work%20with%20Azure%20Service%20Bus%20and%20ASP.NET%20Core&summary=A%20little%20life%20hack%20when%20you%20work%20with%20Azure%20Service%20Bus%20and%20ASP.NET%20Core&source=https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share A little life hack when you work with Azure Service Bus and ASP.NET Core on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f&title=A%20little%20life%20hack%20when%20you%20work%20with%20Azure%20Service%20Bus%20and%20ASP.NET%20Core"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share A little life hack when you work with Azure Service Bus and ASP.NET Core on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share A little life hack when you work with Azure Service Bus and ASP.NET Core on whatsapp" href="https://api.whatsapp.com/send?text=A%20little%20life%20hack%20when%20you%20work%20with%20Azure%20Service%20Bus%20and%20ASP.NET%20Core%20-%20https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share A little life hack when you work with Azure Service Bus and ASP.NET Core on telegram" href="https://telegram.me/share/url?text=A%20little%20life%20hack%20when%20you%20work%20with%20Azure%20Service%20Bus%20and%20ASP.NET%20Core&url=https%3a%2f%2fmaximgorbatyuk.github.io%2fblog%2fdevelopment%2f2021-03-07-asp-net-azure-sb-queues%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://maximgorbatyuk.github.io/>Maxim Gorbatyuk blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
<span><a href=https://github.com/maximgorbatyuk/hugo-blog rel=noopener target=_blank>Hugo source code</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>