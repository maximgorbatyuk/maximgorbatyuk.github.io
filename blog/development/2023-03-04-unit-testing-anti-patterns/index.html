<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Вредные советы по тестированию программ | mgorbatyuk.dev</title><meta name=keywords content=".net,unit_testing,testing,anti_patterns"><meta name=description content="Тестировать программы, которые пишем - долго, нудно и муторно. Поди разбери, что хочет тимлид. Хорошо, что люди придумали много антипаттернов, как можно и юнит-тесты написать, и команду свою запутать. Вроде тесты написаны, а что проверяют и как - не поймешь и не разберешь. В статье ниже я дам вам несколько вредных советов, как можно пошутить над тиммейтами с помощью юнит-тестов."><meta name=author content="Maxim Gorbatyuk"><link rel=canonical href=https://mgorbatyuk.dev/blog/development/2023-03-04-unit-testing-anti-patterns/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6265015896647abb233fd03e24855ee305dded1924938b93dde2bf38ddac7847.css integrity="sha256-YmUBWJZkersjP9A+JIVe4wXd7Rkkk4uT3eK/ON2seEc=" rel="preload stylesheet" as=style><link rel=preload href=/images/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mgorbatyuk.dev/images/avatar.png><link rel=icon type=image/png sizes=16x16 href=https://mgorbatyuk.dev/images/avatar.png><link rel=icon type=image/png sizes=32x32 href=https://mgorbatyuk.dev/images/avatar.png><link rel=apple-touch-icon href=https://mgorbatyuk.dev/images/avatar.png><link rel=mask-icon href=https://mgorbatyuk.dev/images/avatar.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0T63X4Y3MJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0T63X4Y3MJ")</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-86410344-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="Вредные советы по тестированию программ"><meta property="og:description" content="Тестировать программы, которые пишем - долго, нудно и муторно. Поди разбери, что хочет тимлид. Хорошо, что люди придумали много антипаттернов, как можно и юнит-тесты написать, и команду свою запутать. Вроде тесты написаны, а что проверяют и как - не поймешь и не разберешь. В статье ниже я дам вам несколько вредных советов, как можно пошутить над тиммейтами с помощью юнит-тестов."><meta property="og:type" content="article"><meta property="og:url" content="https://mgorbatyuk.dev/blog/development/2023-03-04-unit-testing-anti-patterns/"><meta property="og:image" content="https://mgorbatyuk.dev/images/avatar.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-03-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-04T00:00:00+00:00"><meta property="og:site_name" content="mgorbatyuk.dev"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mgorbatyuk.dev/images/avatar.png"><meta name=twitter:title content="Вредные советы по тестированию программ"><meta name=twitter:description content="Тестировать программы, которые пишем - долго, нудно и муторно. Поди разбери, что хочет тимлид. Хорошо, что люди придумали много антипаттернов, как можно и юнит-тесты написать, и команду свою запутать. Вроде тесты написаны, а что проверяют и как - не поймешь и не разберешь. В статье ниже я дам вам несколько вредных советов, как можно пошутить над тиммейтами с помощью юнит-тестов."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://mgorbatyuk.dev/blog/"},{"@type":"ListItem","position":2,"name":"Вредные советы по тестированию программ","item":"https://mgorbatyuk.dev/blog/development/2023-03-04-unit-testing-anti-patterns/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Вредные советы по тестированию программ","name":"Вредные советы по тестированию программ","description":"Тестировать программы, которые пишем - долго, нудно и муторно. Поди разбери, что хочет тимлид. Хорошо, что люди придумали много антипаттернов, как можно и юнит-тесты написать, и команду свою запутать. Вроде тесты написаны, а что проверяют и как - не поймешь и не разберешь. В статье ниже я дам вам несколько вредных советов, как можно пошутить над тиммейтами с помощью юнит-тестов.","keywords":[".net","unit_testing","testing","anti_patterns"],"articleBody":" Disclaimer:\nСоветы ниже - вредные, доверять им не стоит.\nАнтипаттерны придуманы не мной. В статье я стараюсь дать примеры, на которых будет видно, почему такие подходы и назвали антипаттернами\nКод юнит-тестов - это не second-class код, его тоже нужно писать поддерживаемым, читаемым и понятным для остальных ребят в команде.\nКурсивом - вредный совет, обычным шрифтов - пояснение.\n0. Кукушка (Cuckoo, aka Stranger) Твой класс делает запросы к внешним системам? Отлично, проверь и вызовы тоже вместе с выходными данными. Кому хуже будет?\nПредставим, что у нас есть сервис пользователей, который делает запросы на внешний API:\n// src/user-service.ts import axios from 'axios'; export interface User { id: string; name: string; } export class UserService { async get(userId: string): Promise\u003cUser\u003e { const response = await axios.get(`https://api.example.com/users/${userId}`); return response.data; } } // tests/user-service.test.ts import chai from 'chai'; import { expect } from 'chai'; import * as sinon from 'sinon'; import sinonChai from 'sinon-chai'; import axios from 'axios'; import { UserService } from '../src/user-service'; describe('UserService', () =\u003e { chai.use(sinonChai); let axiosGetStub: sinon.SinonStub; beforeEach(() =\u003e { axiosGetStub = sinon.stub(axios, 'get'); }); afterEach(() =\u003e { axiosGetStub.restore(); }); it('should fetch user data using axios', async () =\u003e { const userId = \"random-uuid\"; const fakeData = { id: userId, name: 'John Doe' }; axiosGetStub.resolves({ data: fakeData }); const result = await new UserService().get(userId); // Assertion expect(axiosGetStub).to.have.been.calledOnceWith(`https://api.example.com/users/${userId}`); expect(result).to.equal(fakeData); }); }) В примере мы проверяем не только выходные данные на соответствие ожидаемому результату, но и факт, что был вызван axios.get с правильными параметрами и урлом. Кажется, что все корректно, однако внутренняя логика работы метода и вызовы внешних сервисов должна быть ответственностью самого класса, а мы лишь проверяем аутпут метода. Класс может поменять вызовы, урлы, параметры, но все так же будет отдавать инстанс юзера. В этом случае тест станет красным, а разработчик не сразу поймет, что нужно делать: логику чинить или тест исправлять.\nУберите проверку axios, и тогда тест станет более надежным:\n// tests/user-service.test.ts it('should fetch user data using axios', async () =\u003e { // Arrange // ... // Act // ... // Assertion expect(result).to.equal(fakeData); }); Есть еще одна вариация этого антипаттерна - “Forty-Foot Pole”. Так называют тесты, проверяющие функционал тех классов, которые лежат не за одним слоем абстракции глубоко внутри.\n1. Один тест на каждый метод (test-per-method) Тимлид просит тебя покрыть тестами новую фичу? Начни с тестов на каждый метод новых классов. А как начал, так и закончи. Тесты есть? Есть! Хватит их писать, достаточно, там еще задачи на доске есть.\nИметь по одному тесту на каждый метод рабочего кода - это хорошее начало, но так функционал системы и пограничные кейсы не проверишь.\n// src/testable-class.ts export class TestableClass { makeSomeLogic1(): number { // some logic goes here return 42; } makeSomeLogic2(): number { // some logic goes here return 43; } makeSomeLogic3(): number { // some logic goes here return 44; } } // tests/testable-class.test.ts import { TestableClass } from './anal-probe-example'; describe('TestableClass', () =\u003e { it('makeSomeLogic1 returns 42', () =\u003e { const target = new TestableClass(); const result = target.makeSomeLogic1(); expect(result).toBe(42); }); it('makeSomeLogic2 returns 43', () =\u003e { const target = new TestableClass(); const result = target.makeSomeLogic2(); expect(result).toBe(43); }); it('makeSomeLogic3 returns 44', () =\u003e { const target = new TestableClass(); const result = target.makeSomeLogic3(); expect(result).toBe(44); }); }); Не останавливайся на первом шагу. Нужно проверять дальше пограничные кейсы и ошибочные сценарии, и тогда код будет более надежным, а ошибки будут найдены гораздо раньше, чем это сделают конечные пользователи системы.\n2. Анальная пробка (Anal probe) Архитектура классов неудобная, куча полей закрыто, но только по ним можно понять результат работы логики? Не беда, рефлексия или хаки помогут тебе проверить то, что скрыто внутри! Погугли, как можно проверять закрытые свойства класса в твоем ЯП и скорее добавь в тест ассерты.\nТестирование приватных полей, методов. Тест знает слишком много о тестируемом классе и лезет не в свое дело. Покажу на примере. Тут у нас тестируемый класс, который изменяет приватное поле:\n// src/testable-class.ts export class TestableClass { constructor(private value: string) {} public makeSomeLogic(): void { this.value += ', 1'; } } // tests/testable-class.test.ts import { TestableClass } from './anal-probe-example'; describe('TestableClass', () =\u003e { it('value should be changed', () =\u003e { const target = new TestableClass('example'); target.makeSomeLogic(); expect((target as any).value).toBe('example, 1'); }); }); Анальной пробкой называют тесты, которые слишком много знают о классе, который тестируют, и лезут не в свое дело. В данном случае тест проверяет значение приватного поля. А что делать, если приватное поле уберут, а логика класса в целом не поменялась? Тест будет красным, придется переписывать.\nУ классов и интерфейсов системы не зря есть публичные свойства и методы - они и предназначены для того, чтобы с их помощью вызывать нужный функционал. Обычно библиотеки разрабатывают так, чтобы внешне система не меняла свой интерфейс, но внутренне она становилась только лучше. Такой подход стоит применить и в коде своего проекта тоже: выставляйте наружу публичный относительно статичный интерфейс, а в тестах проверяйте результаты выходных данных из этого интерфейса.\n3. Happy path Написал фичу, и тимлид требует доказать ее работоспособность? Отлично, сейчас он получит свое! Напиши один тест, проверяющий только один рабочий сценарий использования, и отправляй смело на ревью. Просил доказать, ты доказал. Что не так?\nПроблема таких тестов в том, что они проверяют только прохождение “счастливого пути”, не затрагивая пограничные кейсы и ошибочные сценарии. Например, у нас есть класс проверки возраста и его тест-класс:\n// src/age-detector.ts export class AgeDetector { constructor(private readonly yearOfBirth: number) {} howOldAmI(): number { const currentYear = new Date().getFullYear(); return currentYear - this.yearOfBirth; } } // tests/age-detector.test.ts import { AgeDetector } from './business-service'; describe('AgeDetector', () =\u003e { it('howOldAmI returns 30', () =\u003e { const target = new AgeDetector(1993); const result = target.howOldAmI(); expect(result).toBe(30); }); }); В тесте мы проверили, что класс возвращает разницу. Но что насчет кейсов, когда дата рождения в этом году еще не наступила? А если передали дату в будущем в конструктор класса? А если передали отрицательное число?\n// tests/age-detector.test.ts describe('AgeDetector', () =\u003e { it('howOldAmI returns 30', () =\u003e { const target = new AgeDetector(1993); const result = target.howOldAmI(); expect(result).toBe(30); }); it('ctor throws Error if date is in future', () =\u003e { expect(new AgeDetector(2050)).toThrowError(); }); it('ctor throws Error if date is in the past far from now', () =\u003e { expect(new AgeDetector(1850)).toThrowError(); }); }); Таких пограничных кейсов может быть тысячи, поэтому не останавливайся в написании тестов на только лишь одном успешном сценарии.\nЧем больше ошибок отловишь ты и закрепишь их в тестах, тем надежнее будет твой код.\n4. Слоупок (Slowpoke) В проекте уйма тестов, а темп работы слишком быстрый для тебя? Не беда, есть способ добавить себе пару свободных часов в неделю. Напиши в тестах вызовы внешних сервисов, добавь ожидания ответов, записи файлов. Так тесты будут выполняться дольше, а у тебя появятся свободные полчаса каждый раз, когда отправляешь свой код на тестовый стенд для прогона пайплайна.\nБывают тесты, которые воспроизводятся очень долго. Часто тесты медленные, если они работают с внешними системами, делают запросы в другие сервисы или взаимодействуют с файловой системой. Такие тесты ненадежны и по другим причинам, но в данном кейсе они еще и увеличивают общее время выполнения пайплайна.\n// src/weather-service.ts import { HttpClient, HttpErrorResponse } from '@angular/common/http'; import { Injectable } from '@angular/core'; import { Observable, map, catchError } from 'rxjs'; export interface WeatherData { main: { temp: number; }; weather: { description: string; }[]; } @Injectable({ providedIn: 'root' }) export class WeatherService { private readonly apiKey: string; private readonly baseUrl: string; constructor( private readonly http: HttpClient) { this.apiKey = '1234567890'; this.baseUrl = 'https://api.openweathermap.org/data/2.5/weather'; } getWeather(city: string): Observable\u003cstring\u003e { const url = `${this.baseUrl}?q=${city}\u0026appid=${this.apiKey}\u0026units=metric`; return this.http.get\u003cWeatherData\u003e(url).pipe( map(response =\u003e { const temperature = response.main.temp; const description = response.weather[0].description; return `Temperature in ${city}: ${temperature}°C, ${description}`; }), catchError((error: HttpErrorResponse) =\u003e { return `Error getting weather for ${city}. Status: ${error.status}`; }) ); } } И тест для этого сервиса:\n// tests/weather-service.test.ts import { TestBed } from '@angular/core/testing'; import { WeatherService } from './business-service'; import { HttpClientModule } from '@angular/common/http'; import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing'; describe('WeatherService', () =\u003e { let httpMock: HttpTestingController; beforeEach(() =\u003e { TestBed.configureTestingModule({ imports: [HttpClientModule, HttpClientTestingModule], providers: [WeatherService] }); httpMock = TestBed.inject(HttpTestingController); }); afterEach(() =\u003e { httpMock.verify(); }); it('should return weather information for a city', () =\u003e { const city = 'London'; const target = TestBed.inject(WeatherService); target.getWeather(city).subscribe(response =\u003e { expect(response).toContain(`Temperature in ${city}:`); }); }); }); Если тестов, которые зависят от внешних факторов, много, то и время исполнения будет рандомным и зависеть от состояния нагруженности сети, зависеть от погоды, etc. Тесты пишем так, чтобы они проверяли логику работы на основе заранее определенного ответа внешнего сервиса. Для этого нужно мокать, подменять сервисы заглушками и рефакторить. Пример с моком внешнего сервиса ниже:\n// tests/seather-service.test.ts import { TestBed } from '@angular/core/testing'; import { WeatherData, WeatherService } from './business-service'; import { HttpClientModule } from '@angular/common/http'; import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing'; describe('WeatherService', () =\u003e { let httpMock: HttpTestingController; beforeEach(() =\u003e { TestBed.configureTestingModule({ imports: [HttpClientModule, HttpClientTestingModule], providers: [WeatherService] }); httpMock = TestBed.inject(HttpTestingController); }); afterEach(() =\u003e { httpMock.verify(); }); it('should return weather information for a city', () =\u003e { const city = 'London'; const apiKey = '1234567890'; const target = TestBed.inject(WeatherService); target.getWeather(city).subscribe(response =\u003e { expect(response).toEqual(`Temperature in ${city}: 15°C, cloudy`); }); const request = httpMock.expectOne(`https://api.openweathermap.org/data/2.5/weather?q=${city}\u0026appid=${apiKey}\u0026units=metric`); expect(request.request.method).toBe('GET'); request.flush({ main: { temp: 15 }, weather: [{ description: 'cloudy' }] } as WeatherData); }); it('should handle errors', () =\u003e { const city = 'InvalidCity'; const apiKey = '1234567890'; const target = TestBed.inject(WeatherService); target.getWeather(city).subscribe(response =\u003e { expect(response).toEqual(`Error getting weather for InvalidCity. Status: 404`); }); const request = httpMock.expectOne(`https://api.openweathermap.org/data/2.5/weather?q=${city}\u0026appid=${apiKey}\u0026units=metric`); expect(request.request.method).toBe('GET'); request.flush('', { status: 404, statusText: 'Not Found' }); }); }); 5. Гигант (Giant) Зачем тебе нужно добавлять новые тестфайлы, писать новый код, который подготавливает условия для выполнения тестов, что-то самому сочинять? Есть же вон тестфайл готовый, добавь в него еще пару тестов!\nЕсли тест-файл содержит в себе тысячи строк кода, то причиной может быть ситуация, когда тестируемый класс содержит очень много логики и ответственности. Тут и одной тысячей строк кода не обойтись. Что делать в этом случае? Только дробить и класс, и файл тестов соответственно.\nДробите большие классы, устраняйте god objects из своего проекта. В куче строк кода легко потеряться и допустить ошибки.\n6. Mockery Моки - это круто! Как хочешь, так и подменяй логику. Применяй моки везде и всюду, ведь это единственно верный подход. В классе единственная зависимость и нет бизнес-логики? Все равно! Применяй моки!\nМоки - это отличный способ подменить функциональность. Так можно протестировать свою бизнес-логику, которая зависит на ответе стороннего сервиса, и при эётом не вызывать этот сторонний сервис. Но и перебарщивать с этим не стоит, иначе можно столкнуться с ситуацией, когда вы мокаете сервисы, а потом проверяете работу этих же моков. Нужно соблюдать баланс.\nНапример, на бэкенде популярен паттерн “репозиторий” для создания прослойки между бизнес-логикой и хранилищем данных. Ниже можно увидеть, как мы настраиваем с помощью моков класс, но внутри класса логики-то толком и нет\nА ниже - сам класс. Логики внутри почти нет, в итоге тестировать и нечего особо.\nДаже такие классы нужно тестировать, но в данном случае лучше подойдет мок всей БД, куда сначала мы кладем искомый объект, а потом уже проверяем, что он будет возвращен бизнес-логикой.\n7. Инспектор (Inspector) Ты - тимлид и хочешь помериться долей покрытия тестами с другими тимлидами в чате? тлично, так и нужно делать! Поставь задачу своим ребятам, чтоб обеспечили только 100% code-coverage. А какой ценой? Не имеет значения!\nВ погоне за метрикой покрытия тестами можно так увлечься, что смысл этой метрики будет потерян. Вследствие этого появляются тесты, которые проверяют настолько глубокий функционал внутри класса, что при любом рефакторинге нужно переписывать и тест, даже если логика не поменялась. Это плохо, потому что когда разработчики видят, что тест упал и при это внешний интерфейс класса не был изменен, они пытаются сразу понять, что именно в бизнес-логике они сломали. И как же обидно понять, что тест сломался не потому, что ты что-то сломал, а потому, что ты просто переименовал переменную внутри класса.\nЭтот антипаттерн схож с “анальной пробкой”, но у него иная цель: если “анальная пробка” преследует цель проверить результат работы логики по скрытым полям класса, то тут целью ставят полное покрытие кода тестами, а качество тестов значения не имеет.\nЕсть открытый вопрос на SO, заданный Егором Бугаенко, о том, как написать тест для приватного конструктора класса в Java. Вопрос был задан скорее для того, чтобы собрать мнение сообщества по вопросу, и один из лучших ответов я приведу тут:\nRemember that coverage is meant to be something which is useful to you - you should be in charge of the tool, not the other way round.\n8. Generous Leftovers (aka Chain Gang, Wet Floor) В проекте нужно написать тесты на генерацию CSV и парсинг этого CSV? Отлично, можно же убить двух зайцев! Напиши один тест на генерацию файла, а второй - на его чтение и парсинг. Тимлид точно оценит твою идею.\nПредставим пример двух тестов, один из которых проверяет создание CSV файла, а второй - читает его.\n// test/createFile.test.ts import { expect } from 'chai'; import { promises as fs } from 'fs'; import path from 'path'; describe('File creation', () =\u003e { const filePath = path.join(__dirname, 'testFile.txt'); const fileContent = 'Hello, world!'; it('should create a new file', async () =\u003e { await fs.writeFile(filePath, fileContent); const fileExists = await fs.stat(filePath).then(() =\u003e true).catch(() =\u003e false); expect(fileExists).to.be.true; }); }); // tests/readFile.test.ts import { expect } from 'chai'; import { promises as fs } from 'fs'; import path from 'path'; describe('Read and process file', () =\u003e { const filePath = path.join(__dirname, 'testFile.txt'); const fileContent = 'Hello, world!'; it('should read the file and capitalize the content', async () =\u003e { const content = await fs.readFile(filePath, 'utf-8'); const capitalizedContent = content.toUpperCase(); expect(capitalizedContent).to.equal('HELLO, WORLD!'); }); }); Вывод в консоль:\nFile creation ✔ should create a new file Read and process file ✔ should read the file and capitalize the content 2 passing (4ms) Тимлид не оценит такие тесты. Этот подход плохой, потому что:\nвозникает необходимость запускать некоторые тесты в строгом порядке, возникает зависимость тестов друг от друга, они не атомарны. Лучше создавать файл перед тестом и удалять его после. Так тест будет атомарным и независимым, хоть выполнение будет занимать больше времени\n// tests/readFile.test.ts import { expect } from 'chai'; import { promises as fs } from 'fs'; import path from 'path'; describe('Read and process file', () =\u003e { const filePath = path.join(__dirname, 'testFile.txt'); const fileContent = 'Hello, world!'; // Creating file before the test before(async () =\u003e { await fs.writeFile(filePath, fileContent); }); it('should read the file and capitalize the content', async () =\u003e { const content = await fs.readFile(filePath, 'utf-8'); const capitalizedContent = content.toUpperCase(); expect(capitalizedContent).to.equal('HELLO, WORLD!'); }); // Removing file after the test after(async () =\u003e { await fs.unlink(filePath); }); }); 9. Local Hero (aka “Скрытая зависимость”, “Евангелист ОС”, “Хулиган окружения”) Тимлид заставляет написать тест на класс, в котором используются переменные окружения? Не беда! Пиши смело так, чтобы проходили на сервере CI/CD. НА локальном окружении фейлятся? Да какая разница, гдавное - МР пройдет!\n// src/app-storage.ts interface User { id: number; name: string; } export class AppStorage { private readonly _storage: Array\u003cUser\u003e = []; seed(): void { const database = []; if (process.env.ENVIRONMENT === 'Development') { this._storage.push({ id: 1, name: 'John Doe', }); } } count(): number { return this._storage.length; } } // tests/app-storage.test.ts import { expect } from 'chai'; import { AppStorage } from '../src/app-storage'; describe('AppStorage', () =\u003e { let target: AppStorage; before(async () =\u003e { target = new AppStorage(); }); it('should seed data in development', async () =\u003e { // The test will be green on CI/CD server // because it has process.env.ENVIRONMENT = 'Development'; target.seed(); expect(target.count()).to.equal(1); }); }); Делайте свои тесты независимыми от окружения и внешних обстоятельств максимально. Если логика зависит от переменных окружения, то напишите класс-провайдер этих переменных, и тогда вы сможете его замокать в тестах:\n// src/app-storage.ts export interface IEnvironment { ENVIRONMENT: string; } interface User { id: number; name: string; } export class AppStorage { private readonly _storage: Array\u003cUser\u003e = []; constructor(private readonly env: IEnvironment){} seed(): void { if (this.env.ENVIRONMENT === 'Development') { this._storage.push({ id: 1, name: 'John Doe', }); } } count(): number { return this._storage.length; } } import { expect } from 'chai'; import { AppStorage, IEnvironment } from '../src/app-storage'; describe('AppStorage', () =\u003e { it('should seed data in development', async () =\u003e { const env = { ENVIRONMENT: 'Development', } as IEnvironment; const target = new AppStorage(env); target.seed(); expect(target.count()).to.equal(1); }); }); Автору встречались тесты, котоые фейлились в зависимости от “культуры”, установленной на компьютере: на ноуте автора с английской культурой тесты были зелеными, но у коллег с немецкой они фейлились. Причиной была разница в способе форматирования чисел с дробью: в английской культуре применялась точка, а в немецкой - запятая. Беда была еще в том, что билд-сервер тоже был с английской культурой и не показал, что тесты фейлятся. Решили проблему легко - явно форматировали числа с дробью в тестах с использованием точки.\n10. Придира (Nitpicker) Заставляют писать тесты даже на выгрузку CSV? Ну что ж, отомсти им, сделай ассерт на весь контент! Пусть в случае ошибки помучаются искать, что именно не соответствует ожиданию.\n“Придирой” называют тесты, которые проверяю лишь незначительную часть выходных данных тестируемого метода. Например, клас формирует репорт большого размера, и мы проверяем весь выходной текст на соответствие ожидаемому результату. Казалось бы, такое поведение корректно, однако в случае ошибки в одной из колонок мы получим сложночитаемую ошибку в логах выполнения тестов.\n// src/csv-exporter.ts export interface Person { id: number; name: string; email: string; dateOfBirth: string; } export class CSVExporter { constructor(private readonly data: Person[]) {} private escapeCSVField(field: string): string { return `\"${field.replace(/\"/g, '\"\"')}\"`; } csv(): string { const header = 'id,name,email,dateOfBirth'; const rows = this.data.map(person =\u003e { const fields = [ person.id, this.escapeCSVField(person.name), this.escapeCSVField(person.email), person.dateOfBirth, ]; return fields.join(','); }); return [header, ...rows].join('\\n'); } } import { expect } from 'chai'; import { CSVExporter } from '../src/csv-exporter'; describe('File creation', () =\u003e { it('should create a new file', async () =\u003e { const people = [ { id: 1, name: 'John Doe', email: 'john.doe@example.com', dateOfBirth: '1990-01-01', }, { id: 2, name: 'Jane Doe', email: 'jane.doe@example.com', dateOfBirth: '1992-02-02', }, { id: 3, name: 'Jim Doe', email: 'jim.doe@example.com', dateOfBirth: '1993-02-02', }, ]; const target = new CSVExporter(people); const output = target.csv(); const expected = `id,name,email,dateOfBirth 1,\"John Doe\",\"john.doe@example.com\",1990-01-01 2,\"Jane Doe\",\"jane.doe@example,com\",1992-02-02 3,\"Jim Doe\",\"jim.doe@example.com\",1993-02-02`; expect(output).to.equal(expected); }); }); 1) CSVExporter should return proper csv: AssertionError: expected 'id,name,email,dateOfBirth\\n1,\"John Do…' to equal 'id,name,email,dateOfBirth\\n1,\"John Do…' + expected - actual id,name,email,dateOfBirth 1,\"John Doe\",\"john.doe@example.com\",1990-01-01 -2,\"Jane Doe\",\"jane.doe@example.com\",1992-02-02 +2,\"Jane Doe\",\"jane.doe@example,com\",1992-02-02 3,\"Jim Doe\",\"jim.doe@example.com\",1993-02-02 Ошибка во второй строке полученного CSV - в емейле вместо точки поставлена запятая. Тест показал, что ожидаемый результат не совпадает, но вот не сразу получается разглядет причину ошибки. Старайтесь валидировать частями или разбивать на несколько тесткейсов подобные случаи, чтобы в случае ошибок сразу видеть их причину.\n11. Шкатулка с секретом (Secret Catcher) Нужно написать тест на выбрасывание ошибки? Отлично, тесты ведь нужны для этого! Пусть один из тестов будет красным, ведь мы ждем ошибку там. Главное - не забудь комментарий написать, что фйл теста - это ожидаемо.\nНа первый взгляд, такой тест не делает ничего, ведь в нем нет ассертов. Однако дьявол кроется в деталях. На самом деле, тест надеется, что внутри произойдет эксепшн, и консоль покажет “ожидаемый” текст ошибки в логах.\n// src/secret-catcher-service.ts export class SecretCatcherService { constructor( private someCondition = false) {} doSomeLogic(): void { // do some logic // ... // ... // probably, we change someCondition to true if (this.someCondition) { throw Error('Logic error!'); } } } // tests/secret-catcher-service.test.ts import { expect } from 'chai'; import { SecretCatcherService } from '../src/secret-catcher-service'; describe('SecretCatcherService', () =\u003e { it('should not throw an error if we pass false', () =\u003e { const target = new SecretCatcherService(false); // red test is ok! target.doSomeLogic(); }); }); Лучшим выходом будет отлавливать явно эксепшн и проверять его поля на ожидаемый текст ошибки, например, или иные ее поля. Современные тест-фреймворки могут отлавливать ошибки, поэтому используйте их возможности.\n// tests/secret-catcher-service.test.ts import { expect } from 'chai'; import { SecretCatcherService } from '../src/secret-catcher-service'; describe('SecretCatcherService', () =\u003e { it('should throw an error if we pass true', () =\u003e { const target = new SecretCatcherService(true); expect(() =\u003e target.doSomeLogic()).to.throw('Logic error!'); }); }); 12. Уклонист (Dodger) Пишешь тесты, но внезапно оказалось, что часть логики зависит от внешних сервисов. И никак не замокать. Есть выход! Добавь побольше побочных тестов, особенно если они проверяют маловероятные случаи. Тимлид будет доволен и аппрувнет МР.\n“Уклонистом” можно назвать тест, который проверяет маловероятные кейсы, не оказывающие значительное влияние на поведение класса, но при этом как будто бы специально пропускает важные тесткейсы. Пример привести сложно, ведь тут все сильно зависит от бизнеса, для которого работает приложение - бизнес определяет, какие кейсы важные и какие - маловероятные.\n// src/division.ts export class Division { constructor( private readonly a: number, private readonly b: number) {} result(): number { if (this.b === 0) { throw new Error('Division by zero!'); } return this.a / this.b; } } // tests/division.test.ts import { expect } from 'chai'; import { Division } from '../src/division'; describe('Division', () =\u003e { it('should divide positive numbers. Returns positive result', () =\u003e { const target = new Division(5, 2); expect(target.result()).to.equal(2.5); }); it('should divide one positive and one negative numbers. Returns negative result', () =\u003e { const target = new Division(5, -2); expect(target.result()).to.equal(-2.5); }); it('should divide two negative numbers. Returns positive result', () =\u003e { const target = new Division(-5, -2); expect(target.result()).to.equal(2.5); }); it('should return cirtuclation fraction', () =\u003e { const target = new Division(1, 3); expect(target.result()).to.equal(0.3333333333333333); }); }); В данном академическом примере мы проверяем тоже важные кейсы, однако один пропустили - кейс деления на ноль. Добавим же его:\n// tests/division.test.ts import { expect } from 'chai'; import { Division } from '../src/division'; describe('Division', () =\u003e { // ... // ... // ... it('should catch error if we divide by zero', () =\u003e { const target = new Division(1, 0); expect(() =\u003e target.result()).to.throw(); }); }); 13. Крикун (Loudmouth) Без логов никуда! Код сделал то, что нужно? Пиши в лог об этом. Код зашел в блок if()? Отлично, пиши в лог. А если код зашел в … else {} …? Об этом тоже нужно сообщить. Логов много не бывает!\nНет, бывает. Тест-крикун выдает слишком много информации, полезной разработчику во время отладки, но точно не во время прогона CI/CD пайплайна. Избавляйтесь от лишних информационных записей, сообщающих лишь то, что все идет по плану - пишите в консоль тогда, когда что-то пошло не так. В обилии информации разработчик может пропустить важную информацию, которая поможет ему понять, что произошло.\n// src/division.ts export class Division { constructor( private readonly a: number, private readonly b: number) {} result(): number { if (this.a \u003e 0) console.log('a is positive 0'); if (this.a \u003c 0) console.log('a is negative'); if (this.b \u003e 0) console.log('b is positive'); if (this.b \u003c 0) console.log('b is negative'); if (this.b === 0) { console.log('b equals to zero, division by zero error'); throw new Error('Division by zero!'); } return this.a / this.b; } } Консоль при выполнении тестов класса выше:\nDivision a is positive 0 b is positive ✔ should divide positive numbers. Returns positive result a is positive 0 b is negative ✔ should divide one positive and one negative numbers. Returns negative result a is negative b is negative ✔ should divide two negative numbers. Returns positive result a is positive 0 b is positive ✔ should return cirtuclation fraction a is positive 0 b equals to zero, division by zero error ✔ should catch error if we divide by zero 14. Жадина (Greedy Catcher) Пишешь тест, проверяющий выпадение ошибки? Просто отлавливай исключения и все. Какая разница, какая ошибка возникла? Она ведь возникла же, а значит тест надежный!\nОшибка-то возникла, но где уверенность, что именно та, которую мы ожидаем при определенных условиях? “Жадиной” можно назвать тест, который отлавливают ошибку, но не проверяет причину ее причину. В примере ниже мы валидируем email, но не проверяем, что именно за ошибка возникла - невалидный email или пустое значение пришло в конструктор.\n// src/email.ts export class Email { private static emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/; private readonly email: string; constructor(email: string | null) { if (email == null) { throw new Error('Email cannot be null'); } this.email = email; } get(): string { if (Email.emailRegex.test(this.email)) { return this.email; } throw new Error('Invalid email'); } } // test/email.test.ts import { expect } from 'chai'; import { Email } from '../src/email'; describe('Email', () =\u003e { it('should return email for valid cases', () =\u003e { const validEmails = [ 'test@example.com', 'jane.doe@example.co.uk', 'john_doe@example.io', ]; validEmails.forEach(email =\u003e { expect(new Email(email).get()).to.equal(email); }); }); it('should throw error for invalid emails', () =\u003e { const invalidEmails = [ 'test@example', 'test@.com', 'test@.com.', 'test@.com.', '@example.com', null, '' ]; invalidEmails.forEach(email =\u003e { expect(() =\u003e new Email(email).get()).to.throw(); }); }); }); Нужно проверять не только факт наличия ошибки, но и удостовериться, что она произошла по ожидаемой причине. Попробуйте проверять не только текст сообщения ошибки, но и тип.\n// test/email.test.ts import { expect } from 'chai'; import { Email } from '../src/email'; describe('Email', () =\u003e { it('should throw error for null or empty string', () =\u003e { const invalidEmails = [ null, '' ]; invalidEmails.forEach(email =\u003e { expect(() =\u003e new Email(email)).to.throw('Email cannot be null'); }); }); it('should throw error for invalid emails', () =\u003e { const invalidEmails = [ 'test@example', 'test@.com', 'test@.com.', 'test@.com.', '@example.com' ]; invalidEmails.forEach(email =\u003e { expect(() =\u003e new Email(email).get()).to.throw('Invalid email'); }); }); }); В JS тоже можно добавить кастомные типы ошибок.\nexport class NotFoundError extends Error { public status: number; constructor(message: string) { super(message); this.name = 'NotFoundError'; this.status = 404; } } describe('NotFoundError', () =\u003e { it('should return true for instanceof Error', () =\u003e { const err = new NotFoundError('Not found'); expect(err instanceof Error).to.equal(true); }); it('should return true for instanceof NotFoundError', () =\u003e { const err = new NotFoundError('Not found'); expect(err instanceof NotFoundError).to.equal(true); }); }); 15. Enumerator (aka Test With No Name) Не трать свой креатив на имена тестов, все равно их никто не читает.\nКогда тесткейсов много, а релиз близко, велик соблазн сэкономить время на придумании правильных названий для тестов. В итоге имеем подобное:\nimport { expect } from 'chai'; describe('Some logic', () =\u003e { it('should return true for valid case 1', () =\u003e { // some arrange for test by the first valid conditions // some act // some assert expect(true).to.equal(true); }); it('should return true for valid case 2', () =\u003e { // some arrange for test by the second valid conditions // some act // some assert expect(true).to.equal(true); }); it('should return true for valid case N', () =\u003e { // some arrange for test by the Nth valid conditions // some act // some assert expect(true).to.equal(true); }); }); Правильно подобранные имена позволят в будущем быстрее разбираться, почему после рефакторинга тест упал и что нужно исправлять: отрефакторенный код или тесткейс, который не соответствует новым требованиям и условиям.\n16. Free Ride (aka Piggyback) Сделал багфикс, отправил на МР, а тимлид говорит, что нужно добавить юниттест? Ну и ладно, не парься, есть же уже написанные тесты. Добавь просто еще один ассерт в существующий тест. Это же легче, чем новый тест-кейс писать.\nЧасто бывает, что класс поменяли незначительно, но новый тест придумывать и писать лень. Поэтому вместо нового тесткейса мы добавляем дополнительный ассерт в один из написанных. Представим ситуацию: у нас есть класс User и тест к нему:\n// src/user.ts export class User { constructor( public readonly email: string, public readonly firstName: string, public readonly lastName: string, private isEmailVerified = false) {} verify(): void { if (this.isEmailVerified) { throw new Error('Email already verified'); } this.isEmailVerified = true; } isVerified(): boolean { return this.isEmailVerified; } } // tests/user.test.ts import { expect } from 'chai'; import { User } from '../src/user'; describe('User', () =\u003e { it('should throw an error if we try to verify verified user', () =\u003e { const target = new User( 'john.doe@gmail.com', 'John', 'Doe', true); expect(() =\u003e target.verify()).to.throw('Email already verified'); }); }); Теперь мы добавляем новый метод isSocialEmail:\n// .... isSocialEmail(): boolean { return this.email.endsWith('@facebook.com') || this.email.endsWith('@gmail.com'); } // .... Теперь дополним тесткейс:\nit('should throw an error if we try to verify verified user', () =\u003e { const target = new User( 'john.doe@gmail.com', 'John', 'Doe', true); expect(() =\u003e target.verify()).to.throw('Email already verified'); expect(target.isSocialEmail()).to.be.true; }); Лучше всего будет добавить новый тесткейс, чтобы тесты были независимые и атомарные. В случае, если логика метода verify() сломается и тест будет красным, до проверки isSocialEmail() выполнение даже не дойдет. Получается, что тесткейс на новый функционал не независим и игнорируется в данном случае.\n17. Excessive Setup (aka Mother Hen) Настройки, настройки, сетап и еще настройки! Ну и что, что тест-кейс требует миллионы строк настройки условий? Не разделяй код, не рефактори, оставь как есть и бери следующую задачу.\nТесты, которые требуют много кода для настройки условий, тяжело поддерживать. Иногда фича настолько объемная, что ей нужен такой объем предусловий, но все же это повод задуматься, а не сильно ли много ответственности у класса? А может лучше разделить?\nВ таком тесте тяжело понять суть проверки. Кажется, что настройка слишком “шумная” и сбивает с толку. Если встретили в своем рабочем проекте подобное, то задумайтесь, не повод ли это отрефакторить класс.\n18. Line hitter Ты тимлид и ты усвоил урок, что стопроцентное покрытие кода - это зло. Ну что ж, в публичных методах мы же можем обеспечить полное покрытие, не так ли?\nНа первый взгляд, тест в примере ниже покрывает 100% кода метода, однако суть работы особо и не проверяется и выходные данные не анализируются.\n// src/calculator.ts export class Calculator { constructor( private readonly first: number){} add(second: number): number { return this.first + second; } subtract(second: number): number { return this.first - second; } multiply(second: number): number { return this.first * second; } divide(second: number): number { return this.first / second; } } // test/calculator.test.ts import { expect } from 'chai'; import { Calculator } from '../src/calculator'; describe('Calculator', () =\u003e { it('should call methods', () =\u003e { const add = new Calculator(1).add(1); const substract = new Calculator(1).subtract(1); const multiply = new Calculator(1).multiply(1); expect(new Calculator(1).divide(1)).to.equal(1); }); }); Снова в погоне за метрикой мы упускаем суть тестирования. Метрика - это хорошо, но не самоцель. Сначала напиши тест-кейсы на каждый сценарий, покрой критичный функционал и придуманные пограничные кейсы, а уже потом посмотри на покрытие кода. Если какой-то код остался непокрытым, то может это код нужно удалить, а не тест-кейс добавить?\n19. Лжец (aka Evergreen Tests, Success Against All Odds) Поменял логику работы метода, но тесты не упали? Отлично, какой ты молодец, что сумел написать такие надежные тесты. Так держать!\n“Лжецом” называют тест, который будет зеленый, даже если код тестируемого метода поменяли. Для демонстрации можно вспомнить один из прошлых примеров:\n// src/user.ts export class User { private deletedAt: Date | null = null constructor( public readonly email: string, private isEmailVerified = false, ) {} verify(): void { if (this.isEmailVerified) { throw new Error('Email already verified'); } this.isEmailVerified = true; } isVerified(): boolean { return !this.isDeleted() \u0026\u0026 this.isEmailVerified; } isSocialEmail(): boolean { return this.email.endsWith('@facebook.com') || this.email.endsWith('@gmail.com'); } delete(): void { if (this.deletedAt != null) { throw new Error('User is already removed'); } this.deletedAt = new Date(); } isDeleted(): boolean { return this.deletedAt != null; } } // tests/user.test.ts import { expect } from 'chai'; import { User } from '../src/user'; describe('User', () =\u003e { it('.isVerified should return false if user was removed', () =\u003e { const target = new User('john.doe@gmail.com', false); target.delete(); expect(target.isVerified()).to.be.false; }); }); Теперь поменяем проверку в методе isVerified():\nisVerified(): boolean { return /*!this.isDeleted() \u0026\u0026*/ this.isEmailVerified; } Тест до сих пор зеленый даже при условии, что код метода был изменен:\nit('.isVerified should return false if user was removed', () =\u003e { const target = new User('john.doe@gmail.com', false); target.delete(); expect(target.isVerified()).to.be.false; }); Все потому, что тест не проверяет подробно состояние тестируемого объекта и не удостоверяется, какие именно условия привели к ожидаемому результату. В качестве решения можно добавить мутационные тесты, которые будут проверять, что тесты не лгут. Мутационный тест - это тест, который меняет или код бизнес-классов, или ассерты в тестах, и проверяет, что тесты упали. Если тесты не упали, то это значит, что доверия к ним нет.\nЗаключение В этой статье мы рассмотрели 19 антипаттернов в юнит-тестировании. Надеюсь, что теперь ты попадешь в эти ловушки. Код юниттестов - не second-class-citizen, их тоже нужно писать “чистыми” и понятными. Практикуйся чаще, и тогда код твоего проекта будет надежней, тестировщик будет меньше на тебя ругаться, а тимлид - меньше краснеть.\nИсточники https://stackoverflow.com/questions/333682/unit-testing-anti-patterns-catalogue https://archive.is/3acB#selection-119.0-119.17 https://www.yegor256.com/2018/12/11/unit-testing-anti-patterns.html https://blog.codepipes.com/testing/software-testing-antipatterns.html ","wordCount":"5252","inLanguage":"en","datePublished":"2023-03-04T00:00:00Z","dateModified":"2023-03-04T00:00:00Z","author":{"@type":"Person","name":"Maxim Gorbatyuk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mgorbatyuk.dev/blog/development/2023-03-04-unit-testing-anti-patterns/"},"publisher":{"@type":"Organization","name":"mgorbatyuk.dev","logo":{"@type":"ImageObject","url":"https://mgorbatyuk.dev/images/avatar.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mgorbatyuk.dev/ accesskey=h title="mgorbatyuk.dev (Alt + H)"><img src=https://mgorbatyuk.dev/images/avatar.png alt=logo aria-label=logo height=35>mgorbatyuk.dev</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://mgorbatyuk.dev/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://mgorbatyuk.dev/about/ title="About me"><span>About me</span></a></li><li><a href=https://mgorbatyuk.dev/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://mgorbatyuk.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://mgorbatyuk.dev/speaking/ title="Public speaking"><span>Public speaking</span></a></li><li><a href=https://maximgorbatyuk.notion.site/maximgorbatyuk/Knowledge-base-f87dcc7b0e98498499cfd606d06bd0c7 title=KB><span>KB</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Вредные советы по тестированию программ</h1><div class=post-description>Тестировать программы, которые пишем - долго, нудно и муторно. Поди разбери, что хочет тимлид. Хорошо, что люди придумали много антипаттернов, как можно и юнит-тесты написать, и команду свою запутать. Вроде тесты написаны, а что проверяют и как - не поймешь и не разберешь. В статье ниже я дам вам несколько вредных советов, как можно пошутить над тиммейтами с помощью юнит-тестов.</div><div class=post-meta><span title='2023-03-04 00:00:00 +0000 UTC'>March 4, 2023</span>&nbsp;·&nbsp;25 min&nbsp;·&nbsp;Maxim Gorbatyuk</div></header><div class=post-content><blockquote><p>Disclaimer:</p><ol><li><p>Советы ниже - <strong>вредные</strong>, доверять им не стоит.</p></li><li><p>Антипаттерны придуманы не мной. В статье я стараюсь дать примеры, на которых будет видно, почему такие подходы и назвали антипаттернами</p></li><li><p>Код юнит-тестов - это не second-class код, его тоже нужно писать поддерживаемым, читаемым и понятным для остальных ребят в команде.</p></li><li><p>Курсивом - вредный совет, обычным шрифтов - пояснение.</p></li></ol></blockquote><h2 id=0-кукушка-cuckoo-aka-stranger>0. Кукушка (Cuckoo, aka Stranger)<a hidden class=anchor aria-hidden=true href=#0-кукушка-cuckoo-aka-stranger>#</a></h2><p><em>Твой класс делает запросы к внешним системам? Отлично, проверь и вызовы тоже вместе с выходными данными. Кому хуже будет?</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/cuckoo-jack-black.gif alt=Cuckoo!></p><p>Представим, что у нас есть сервис пользователей, который делает запросы на внешний API:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/user-service.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>axios</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;axios&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserService</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>User</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>`https://api.example.com/users/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/user-service.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chai</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>sinon</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;sinon&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinonChai</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;sinon-chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>axios</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;axios&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>UserService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/user-service&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;UserService&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>chai</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>sinonChai</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>axiosGetStub</span>: <span style=color:#66d9ef>sinon.SinonStub</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeEach</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>axiosGetStub</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>(<span style=color:#a6e22e>axios</span>, <span style=color:#e6db74>&#39;get&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>afterEach</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>axiosGetStub</span>.<span style=color:#a6e22e>restore</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should fetch user data using axios&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;random-uuid&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fakeData</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>userId</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Doe&#39;</span> };
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>axiosGetStub</span>.<span style=color:#a6e22e>resolves</span>({ <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>fakeData</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UserService</span>().<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Assertion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>axiosGetStub</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>been</span>.<span style=color:#a6e22e>calledOnceWith</span>(<span style=color:#e6db74>`https://api.example.com/users/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>fakeData</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>В примере мы проверяем не только выходные данные на соответствие ожидаемому результату, но и факт, что был вызван <code>axios.get</code> с правильными параметрами и урлом. Кажется, что все корректно, однако внутренняя логика работы метода и вызовы внешних сервисов должна быть ответственностью самого класса, а мы лишь проверяем аутпут метода. Класс может поменять вызовы, урлы, параметры, но все так же будет отдавать инстанс юзера. В этом случае тест станет красным, а разработчик не сразу поймет, что нужно делать: логику чинить или тест исправлять.</p><p>Уберите проверку axios, и тогда тест станет более надежным:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/user-service.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should fetch user data using axios&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Assertion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>fakeData</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Есть еще одна вариация этого антипаттерна - <a href=https://stackoverflow.com/a/339247>&ldquo;Forty-Foot Pole&rdquo;</a>. Так называют тесты, проверяющие функционал тех классов, которые лежат не за одним слоем абстракции глубоко внутри.</p><h2 id=1-один-тест-на-каждый-метод-test-per-method>1. Один тест на каждый метод (test-per-method)<a hidden class=anchor aria-hidden=true href=#1-один-тест-на-каждый-метод-test-per-method>#</a></h2><p><em>Тимлид просит тебя покрыть тестами новую фичу? Начни с тестов на каждый метод новых классов. А как начал, так и закончи. Тесты есть? Есть! Хватит их писать, достаточно, там еще задачи на доске есть.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/stop_sign.jpeg alt=Stop></p><p>Иметь по одному тесту на каждый метод рабочего кода - это хорошее начало, но так функционал системы и пограничные кейсы не проверишь.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/testable-class.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestableClass</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>makeSomeLogic1</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// some logic goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>42</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>makeSomeLogic2</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// some logic goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>43</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>makeSomeLogic3</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// some logic goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>44</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/testable-class.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>TestableClass</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./anal-probe-example&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;TestableClass&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;makeSomeLogic1 returns 42&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TestableClass</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>makeSomeLogic1</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>42</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;makeSomeLogic2 returns 43&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TestableClass</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>makeSomeLogic2</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>43</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;makeSomeLogic3 returns 44&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TestableClass</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>makeSomeLogic3</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>44</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Не останавливайся на первом шагу. Нужно проверять дальше пограничные кейсы и ошибочные сценарии, и тогда код будет более надежным, а ошибки будут найдены гораздо раньше, чем это сделают конечные пользователи системы.</p><h2 id=2-анальная-пробка-anal-probe>2. Анальная пробка (Anal probe)<a hidden class=anchor aria-hidden=true href=#2-анальная-пробка-anal-probe>#</a></h2><p><em>Архитектура классов неудобная, куча полей закрыто, но только по ним можно понять результат работы логики? Не беда, рефлексия или хаки помогут тебе проверить то, что скрыто внутри! Погугли, как можно проверять закрытые свойства класса в твоем ЯП и скорее добавь в тест ассерты.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/censored.png alt=Censored></p><p>Тестирование приватных полей, методов. Тест знает слишком много о тестируемом классе и лезет не в свое дело. Покажу на примере. Тут у нас тестируемый класс, который изменяет приватное поле:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/testable-class.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestableClass</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>string</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>makeSomeLogic</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;, 1&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/testable-class.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>TestableClass</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./anal-probe-example&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;TestableClass&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;value should be changed&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TestableClass</span>(<span style=color:#e6db74>&#39;example&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>makeSomeLogic</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>((<span style=color:#a6e22e>target</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>).<span style=color:#a6e22e>value</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;example, 1&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Анальной пробкой называют тесты, которые слишком много знают о классе, который тестируют, и лезут не в свое дело. В данном случае тест проверяет значение приватного поля. А что делать, если приватное поле уберут, а логика класса в целом не поменялась? Тест будет красным, придется переписывать.</p><p>У классов и интерфейсов системы не зря есть публичные свойства и методы - они и предназначены для того, чтобы с их помощью вызывать нужный функционал. Обычно библиотеки разрабатывают так, чтобы внешне система не меняла свой интерфейс, но внутренне она становилась только лучше. Такой подход стоит применить и в коде своего проекта тоже: выставляйте наружу публичный относительно статичный интерфейс, а в тестах проверяйте результаты выходных данных из этого интерфейса.</p><h2 id=3-happy-path>3. Happy path<a hidden class=anchor aria-hidden=true href=#3-happy-path>#</a></h2><p><em>Написал фичу, и тимлид требует доказать ее работоспособность? Отлично, сейчас он получит свое! Напиши один тест, проверяющий только один рабочий сценарий использования, и отправляй смело на ревью. Просил доказать, ты доказал. Что не так?</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/pepe-clap.gif alt="Happy pepe"></p><p>Проблема таких тестов в том, что они проверяют только прохождение &ldquo;счастливого пути&rdquo;, не затрагивая пограничные кейсы и ошибочные сценарии. Например, у нас есть класс проверки возраста и его тест-класс:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/age-detector.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AgeDetector</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>yearOfBirth</span>: <span style=color:#66d9ef>number</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>howOldAmI</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentYear</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>getFullYear</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>currentYear</span> <span style=color:#f92672>-</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>yearOfBirth</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/age-detector.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AgeDetector</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./business-service&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;AgeDetector&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;howOldAmI returns 30&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AgeDetector</span>(<span style=color:#ae81ff>1993</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>howOldAmI</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>30</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>В тесте мы проверили, что класс возвращает разницу. Но что насчет кейсов, когда дата рождения в этом году еще не наступила? А если передали дату в будущем в конструктор класса? А если передали отрицательное число?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/age-detector.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;AgeDetector&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;howOldAmI returns 30&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AgeDetector</span>(<span style=color:#ae81ff>1993</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>howOldAmI</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>30</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;ctor throws Error if date is in future&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AgeDetector</span>(<span style=color:#ae81ff>2050</span>)).<span style=color:#a6e22e>toThrowError</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;ctor throws Error if date is in the past far from now&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AgeDetector</span>(<span style=color:#ae81ff>1850</span>)).<span style=color:#a6e22e>toThrowError</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Таких пограничных кейсов может быть тысячи, поэтому не останавливайся в написании тестов на только лишь одном успешном сценарии.</p><blockquote><p>Чем больше ошибок отловишь ты и закрепишь их в тестах, тем надежнее будет твой код.</p></blockquote><h2 id=4-слоупок-slowpoke>4. Слоупок (Slowpoke)<a hidden class=anchor aria-hidden=true href=#4-слоупок-slowpoke>#</a></h2><p><em>В проекте уйма тестов, а темп работы слишком быстрый для тебя? Не беда, есть способ добавить себе пару свободных часов в неделю. Напиши в тестах вызовы внешних сервисов, добавь ожидания ответов, записи файлов. Так тесты будут выполняться дольше, а у тебя появятся свободные полчаса каждый раз, когда отправляешь свой код на тестовый стенд для прогона пайплайна.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/slowpoke.jpg alt=Slowpoke></p><p>Бывают тесты, которые воспроизводятся очень долго. Часто тесты медленные, если они работают с внешними системами, делают запросы в другие сервисы или взаимодействуют с файловой системой. Такие тесты ненадежны и по другим причинам, но в данном кейсе они еще и увеличивают общее время выполнения пайплайна.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/weather-service.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>HttpClient</span>, <span style=color:#a6e22e>HttpErrorResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/common/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Injectable</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/core&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Observable</span>, <span style=color:#a6e22e>map</span>, <span style=color:#a6e22e>catchError</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;rxjs&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>WeatherData</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>main</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>temp</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>weather</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    }[];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@Injectable</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>providedIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;root&#39;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WeatherService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>apiKey</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>baseUrl</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>http</span>: <span style=color:#66d9ef>HttpClient</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>apiKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;1234567890&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>baseUrl</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://api.openweathermap.org/data/2.5/weather&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getWeather</span>(<span style=color:#a6e22e>city</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Observable</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>baseUrl</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?q=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;appid=</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>apiKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;units=metric`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>http</span>.<span style=color:#66d9ef>get</span>&lt;<span style=color:#f92672>WeatherData</span>&gt;(<span style=color:#a6e22e>url</span>).<span style=color:#a6e22e>pipe</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>response</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>temperature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>temp</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>description</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>weather</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>description</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`Temperature in </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>temperature</span><span style=color:#e6db74>}</span><span style=color:#e6db74>°C, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>description</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>catchError</span>((<span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>HttpErrorResponse</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`Error getting weather for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. Status: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>И тест для этого сервиса:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/weather-service.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>TestBed</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/core/testing&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WeatherService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./business-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>HttpClientModule</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/common/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>HttpClientTestingModule</span>, <span style=color:#a6e22e>HttpTestingController</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/common/http/testing&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;WeatherService&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>httpMock</span>: <span style=color:#66d9ef>HttpTestingController</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeEach</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>configureTestingModule</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>imports</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>HttpClientModule</span>, <span style=color:#a6e22e>HttpClientTestingModule</span>],
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>providers</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>WeatherService</span>]
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>httpMock</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>inject</span>(<span style=color:#a6e22e>HttpTestingController</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>afterEach</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>httpMock</span>.<span style=color:#a6e22e>verify</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return weather information for a city&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>city</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;London&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>inject</span>(<span style=color:#a6e22e>WeatherService</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>getWeather</span>(<span style=color:#a6e22e>city</span>).<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>response</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>).<span style=color:#a6e22e>toContain</span>(<span style=color:#e6db74>`Temperature in </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Если тестов, которые зависят от внешних факторов, много, то и время исполнения будет рандомным и зависеть от состояния нагруженности сети, зависеть от погоды, etc. Тесты пишем так, чтобы они проверяли логику работы на основе заранее определенного ответа внешнего сервиса. Для этого нужно мокать, подменять сервисы заглушками и рефакторить. Пример с моком внешнего сервиса ниже:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/seather-service.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>TestBed</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/core/testing&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WeatherData</span>, <span style=color:#a6e22e>WeatherService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./business-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>HttpClientModule</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/common/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>HttpClientTestingModule</span>, <span style=color:#a6e22e>HttpTestingController</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@angular/common/http/testing&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;WeatherService&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>httpMock</span>: <span style=color:#66d9ef>HttpTestingController</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeEach</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>configureTestingModule</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>imports</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>HttpClientModule</span>, <span style=color:#a6e22e>HttpClientTestingModule</span>],
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>providers</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>WeatherService</span>]
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>httpMock</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>inject</span>(<span style=color:#a6e22e>HttpTestingController</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>afterEach</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>httpMock</span>.<span style=color:#a6e22e>verify</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return weather information for a city&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>city</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;London&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apiKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;1234567890&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>inject</span>(<span style=color:#a6e22e>WeatherService</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>getWeather</span>(<span style=color:#a6e22e>city</span>).<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>response</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#e6db74>`Temperature in </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: 15°C, cloudy`</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>httpMock</span>.<span style=color:#a6e22e>expectOne</span>(<span style=color:#e6db74>`https://api.openweathermap.org/data/2.5/weather?q=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;appid=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>apiKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;units=metric`</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;GET&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>flush</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>main</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>temp</span>: <span style=color:#66d9ef>15</span> },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>weather</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;cloudy&#39;</span> }]
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>WeatherData</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should handle errors&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>city</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;InvalidCity&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apiKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;1234567890&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TestBed</span>.<span style=color:#a6e22e>inject</span>(<span style=color:#a6e22e>WeatherService</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>getWeather</span>(<span style=color:#a6e22e>city</span>).<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>response</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#e6db74>`Error getting weather for InvalidCity. Status: 404`</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>httpMock</span>.<span style=color:#a6e22e>expectOne</span>(<span style=color:#e6db74>`https://api.openweathermap.org/data/2.5/weather?q=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>city</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;appid=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>apiKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;units=metric`</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;GET&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>flush</span>(<span style=color:#e6db74>&#39;&#39;</span>, { <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>404</span>, <span style=color:#a6e22e>statusText</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Not Found&#39;</span> });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=5-гигант-giant>5. Гигант (Giant)<a hidden class=anchor aria-hidden=true href=#5-гигант-giant>#</a></h2><p><em>Зачем тебе нужно добавлять новые тестфайлы, писать новый код, который подготавливает условия для выполнения тестов, что-то самому сочинять? Есть же вон тестфайл готовый, добавь в него еще пару тестов!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/long_unit-test.png alt="Giant unittest"></p><p>Если тест-файл содержит в себе тысячи строк кода, то причиной может быть ситуация, когда тестируемый класс содержит очень много логики и ответственности. Тут и одной тысячей строк кода не обойтись. Что делать в этом случае? Только дробить и класс, и файл тестов соответственно.</p><p><img loading=lazy src=/images/blog/development/2023-03-04/1_k_line_of_tests.png alt="1k lines of test"></p><p><img loading=lazy src=/images/blog/development/2023-03-04/over9000.png alt="9k lines of logic"></p><p>Дробите большие классы, устраняйте god objects из своего проекта. В куче строк кода легко потеряться и допустить ошибки.</p><h2 id=6-mockery>6. Mockery<a hidden class=anchor aria-hidden=true href=#6-mockery>#</a></h2><p><em>Моки - это круто! Как хочешь, так и подменяй логику. Применяй моки везде и всюду, ведь это единственно верный подход. В классе единственная зависимость и нет бизнес-логики? Все равно! Применяй моки!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/mockery.jpeg alt=Mockery></p><p>Моки - это отличный способ подменить функциональность. Так можно протестировать свою бизнес-логику, которая зависит на ответе стороннего сервиса, и при эётом не вызывать этот сторонний сервис. Но и перебарщивать с этим не стоит, иначе можно столкнуться с ситуацией, когда вы мокаете сервисы, а потом проверяете работу этих же моков. Нужно соблюдать баланс.</p><p>Например, на бэкенде популярен паттерн &ldquo;репозиторий&rdquo; для создания прослойки между бизнес-логикой и хранилищем данных. Ниже можно увидеть, как мы настраиваем с помощью моков класс, но внутри класса логики-то толком и нет</p><p><img loading=lazy src=/images/blog/development/2023-03-04/mock_dotnet.png alt="Setup mocks for testclass"></p><p>А ниже - сам класс. Логики внутри почти нет, в итоге тестировать и нечего особо.</p><p><img loading=lazy src=/images/blog/development/2023-03-04/class_under_tests_dotnet.png alt="Setup mocks for testclass"></p><p>Даже такие классы нужно тестировать, но в данном случае лучше подойдет мок всей БД, куда сначала мы кладем искомый объект, а потом уже проверяем, что он будет возвращен бизнес-логикой.</p><h2 id=7-инспектор-inspector>7. Инспектор (Inspector)<a hidden class=anchor aria-hidden=true href=#7-инспектор-inspector>#</a></h2><p><em>Ты - тимлид и хочешь помериться долей покрытия тестами с другими тимлидами в чате? тлично, так и нужно делать! Поставь задачу своим ребятам, чтоб обеспечили только 100% code-coverage. А какой ценой? Не имеет значения!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/what_did_it_cost.png alt="What did it cost?"></p><p>В погоне за метрикой покрытия тестами можно так увлечься, что смысл этой метрики будет потерян. Вследствие этого появляются тесты, которые проверяют настолько глубокий функционал внутри класса, что при любом рефакторинге нужно переписывать и тест, даже если логика не поменялась. Это плохо, потому что когда разработчики видят, что тест упал и при это внешний интерфейс класса не был изменен, они пытаются сразу понять, что именно в бизнес-логике они сломали. И как же обидно понять, что тест сломался не потому, что ты что-то сломал, а потому, что ты просто переименовал переменную внутри класса.</p><p>Этот антипаттерн схож с &ldquo;анальной пробкой&rdquo;, но у него иная цель: если &ldquo;анальная пробка&rdquo; преследует цель проверить результат работы логики по скрытым полям класса, то тут целью ставят полное покрытие кода тестами, а качество тестов значения не имеет.</p><p>Есть открытый <a href=https://stackoverflow.com/q/4520216>вопрос на SO</a>, заданный Егором Бугаенко, о том, как написать тест для приватного конструктора класса в Java. Вопрос был задан скорее для того, чтобы собрать мнение сообщества по вопросу, и <a href=https://stackoverflow.com/a/4520241>один из лучших ответов</a> я приведу тут:</p><blockquote><p>Remember that coverage is meant to be something which is useful to you - you should be in charge of the tool, not the other way round.</p></blockquote><h2 id=8-generous-leftovers-aka-chain-gang-wet-floor>8. Generous Leftovers (aka Chain Gang, Wet Floor)<a hidden class=anchor aria-hidden=true href=#8-generous-leftovers-aka-chain-gang-wet-floor>#</a></h2><p><em>В проекте нужно написать тесты на генерацию CSV и парсинг этого CSV? Отлично, можно же убить двух зайцев! Напиши один тест на генерацию файла, а второй - на его чтение и парсинг. Тимлид точно оценит твою идею.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/brugge.jpeg alt=Brugge></p><p>Представим пример двух тестов, один из которых проверяет создание CSV файла, а второй - читает его.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// test/createFile.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>promises</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>fs</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;File creation&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;testFile.txt&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileContent</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello, world!&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should create a new file&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>fileContent</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileExists</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>stat</span>(<span style=color:#a6e22e>filePath</span>).<span style=color:#a6e22e>then</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>).<span style=color:#66d9ef>catch</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>fileExists</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/readFile.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>promises</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>fs</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Read and process file&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;testFile.txt&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileContent</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello, world!&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should read the file and capitalize the content&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>content</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#e6db74>&#39;utf-8&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>capitalizedContent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>toUpperCase</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>capitalizedContent</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#e6db74>&#39;HELLO, WORLD!&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Вывод в консоль:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>File creation
</span></span><span style=display:flex><span>    ✔ should create a new file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Read and process file
</span></span><span style=display:flex><span>    ✔ should read the file and capitalize the content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> passing <span style=color:#f92672>(</span>4ms<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Тимлид не оценит такие тесты. Этот подход плохой, потому что:</p><ul><li>возникает необходимость запускать некоторые тесты в строгом порядке,</li><li>возникает зависимость тестов друг от друга, они не атомарны.</li></ul><p>Лучше создавать файл перед тестом и удалять его после. Так тест будет атомарным и независимым, хоть выполнение будет занимать больше времени</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/readFile.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>promises</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>fs</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Read and process file&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;testFile.txt&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileContent</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello, world!&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Creating file before the test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>before</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>fileContent</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should read the file and capitalize the content&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>content</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#e6db74>&#39;utf-8&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>capitalizedContent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>toUpperCase</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>capitalizedContent</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#e6db74>&#39;HELLO, WORLD!&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Removing file after the test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>after</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>unlink</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=9-local-hero-aka-скрытая-зависимость-евангелист-ос-хулиган-окружения>9. Local Hero (aka &ldquo;Скрытая зависимость&rdquo;, &ldquo;Евангелист ОС&rdquo;, &ldquo;Хулиган окружения&rdquo;)<a hidden class=anchor aria-hidden=true href=#9-local-hero-aka-скрытая-зависимость-евангелист-ос-хулиган-окружения>#</a></h2><p><em>Тимлид заставляет написать тест на класс, в котором используются переменные окружения? Не беда! Пиши смело так, чтобы проходили на сервере CI/CD. НА локальном окружении фейлятся? Да какая разница, гдавное - МР пройдет!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/captain_america.png alt="Captain America"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/app-storage.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppStorage</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>_storage</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>User</span>&gt; <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>seed</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>database</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>ENVIRONMENT</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;Development&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_storage</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Doe&#39;</span>,
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>count</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_storage</span>.<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/app-storage.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AppStorage</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/app-storage&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;AppStorage&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>target</span>: <span style=color:#66d9ef>AppStorage</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>before</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AppStorage</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should seed data in development&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// The test will be green on CI/CD server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// because it has process.env.ENVIRONMENT = &#39;Development&#39;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>seed</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>count</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Делайте свои тесты независимыми от окружения и внешних обстоятельств максимально. Если логика зависит от переменных окружения, то напишите класс-провайдер этих переменных, и тогда вы сможете его замокать в тестах:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/app-storage.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IEnvironment</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ENVIRONMENT</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppStorage</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>_storage</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>User</span>&gt; <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>env</span>: <span style=color:#66d9ef>IEnvironment</span>){}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>seed</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>ENVIRONMENT</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;Development&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_storage</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Doe&#39;</span>,
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>count</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_storage</span>.<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AppStorage</span>, <span style=color:#a6e22e>IEnvironment</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/app-storage&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;AppStorage&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should seed data in development&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>env</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ENVIRONMENT</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Development&#39;</span>,
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>IEnvironment</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AppStorage</span>(<span style=color:#a6e22e>env</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>seed</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>count</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Автору встречались тесты, котоые фейлились в зависимости от &ldquo;культуры&rdquo;, установленной на компьютере: на ноуте автора с английской культурой тесты были зелеными, но у коллег с немецкой они фейлились. Причиной была разница в способе форматирования чисел с дробью: в английской культуре применялась точка, а в немецкой - запятая. Беда была еще в том, что билд-сервер тоже был с английской культурой и не показал, что тесты фейлятся. Решили проблему легко - явно форматировали числа с дробью в тестах с использованием точки.</p><h2 id=10-придира-nitpicker>10. Придира (Nitpicker)<a hidden class=anchor aria-hidden=true href=#10-придира-nitpicker>#</a></h2><p><em>Заставляют писать тесты даже на выгрузку CSV? Ну что ж, отомсти им, сделай ассерт на весь контент! Пусть в случае ошибки помучаются искать, что именно не соответствует ожиданию.</em></p><p>&ldquo;Придирой&rdquo; называют тесты, которые проверяю лишь незначительную часть выходных данных тестируемого метода. Например, клас формирует репорт большого размера, и мы проверяем весь выходной текст на соответствие ожидаемому результату. Казалось бы, такое поведение корректно, однако в случае ошибки в одной из колонок мы получим сложночитаемую ошибку в логах выполнения тестов.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/csv-exporter.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Person</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dateOfBirth</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CSVExporter</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>Person</span>[]) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>escapeCSVField</span>(<span style=color:#a6e22e>field</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/&#34;/g</span>, <span style=color:#e6db74>&#39;&#34;&#34;&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>csv</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>header</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;id,name,email,dateOfBirth&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rows</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>person</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fields</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>person</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>escapeCSVField</span>(<span style=color:#a6e22e>person</span>.<span style=color:#a6e22e>name</span>),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>escapeCSVField</span>(<span style=color:#a6e22e>person</span>.<span style=color:#a6e22e>email</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>person</span>.<span style=color:#a6e22e>dateOfBirth</span>,
</span></span><span style=display:flex><span>            ];
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>header</span>, ...<span style=color:#a6e22e>rows</span>].<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>CSVExporter</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/csv-exporter&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;File creation&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should create a new file&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>people</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Doe&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;john.doe@example.com&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dateOfBirth</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1990-01-01&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>2</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Jane Doe&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;jane.doe@example.com&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dateOfBirth</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1992-02-02&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Jim Doe&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;jim.doe@example.com&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dateOfBirth</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1993-02-02&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CSVExporter</span>(<span style=color:#a6e22e>people</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>csv</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`id,name,email,dateOfBirth
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        1,&#34;John Doe&#34;,&#34;john.doe@example.com&#34;,1990-01-01
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        2,&#34;Jane Doe&#34;,&#34;jane.doe@example,com&#34;,1992-02-02
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        3,&#34;Jim Doe&#34;,&#34;jim.doe@example.com&#34;,1993-02-02`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>output</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>expected</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1<span style=color:#f92672>)</span> CSVExporter
</span></span><span style=display:flex><span>should <span style=color:#66d9ef>return</span> proper csv:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    AssertionError: expected <span style=color:#e6db74>&#39;id,name,email,dateOfBirth\n1,&#34;John Do…&#39;</span> to equal <span style=color:#e6db74>&#39;id,name,email,dateOfBirth\n1,&#34;John Do…&#39;</span>
</span></span><span style=display:flex><span>    + expected - actual
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    id,name,email,dateOfBirth
</span></span><span style=display:flex><span>    1,<span style=color:#e6db74>&#34;John Doe&#34;</span>,<span style=color:#e6db74>&#34;john.doe@example.com&#34;</span>,1990-01-01
</span></span><span style=display:flex><span>    -2,<span style=color:#e6db74>&#34;Jane Doe&#34;</span>,<span style=color:#e6db74>&#34;jane.doe@example.com&#34;</span>,1992-02-02
</span></span><span style=display:flex><span>    +2,<span style=color:#e6db74>&#34;Jane Doe&#34;</span>,<span style=color:#e6db74>&#34;jane.doe@example,com&#34;</span>,1992-02-02
</span></span><span style=display:flex><span>    3,<span style=color:#e6db74>&#34;Jim Doe&#34;</span>,<span style=color:#e6db74>&#34;jim.doe@example.com&#34;</span>,1993-02-02
</span></span></code></pre></div><p>Ошибка во второй строке полученного CSV - в емейле вместо точки поставлена запятая. Тест показал, что ожидаемый результат не совпадает, но вот не сразу получается разглядет причину ошибки. Старайтесь валидировать частями или разбивать на несколько тесткейсов подобные случаи, чтобы в случае ошибок сразу видеть их причину.</p><h2 id=11-шкатулка-с-секретом-secret-catcher>11. Шкатулка с секретом (Secret Catcher)<a hidden class=anchor aria-hidden=true href=#11-шкатулка-с-секретом-secret-catcher>#</a></h2><p><em>Нужно написать тест на выбрасывание ошибки? Отлично, тесты ведь нужны для этого! Пусть один из тестов будет красным, ведь мы ждем ошибку там. Главное - не забудь комментарий написать, что фйл теста - это ожидаемо.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/secret_box_sponge.png alt="The secret box"></p><p>На первый взгляд, такой тест не делает ничего, ведь в нем нет ассертов. Однако дьявол кроется в деталях. На самом деле, тест надеется, что внутри произойдет эксепшн, и консоль покажет &ldquo;ожидаемый&rdquo; текст ошибки в логах.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/secret-catcher-service.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecretCatcherService</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>someCondition</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>doSomeLogic</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// do some logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// probably, we change someCondition to true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>someCondition</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> Error(<span style=color:#e6db74>&#39;Logic error!&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/secret-catcher-service.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SecretCatcherService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/secret-catcher-service&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;SecretCatcherService&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should not throw an error if we pass false&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SecretCatcherService</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// red test is ok!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>doSomeLogic</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Лучшим выходом будет отлавливать явно эксепшн и проверять его поля на ожидаемый текст ошибки, например, или иные ее поля. Современные тест-фреймворки могут отлавливать ошибки, поэтому используйте их возможности.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/secret-catcher-service.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SecretCatcherService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/secret-catcher-service&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;SecretCatcherService&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should throw an error if we pass true&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SecretCatcherService</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>doSomeLogic</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>(<span style=color:#e6db74>&#39;Logic error!&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=12-уклонист-dodger>12. Уклонист (Dodger)<a hidden class=anchor aria-hidden=true href=#12-уклонист-dodger>#</a></h2><p><em>Пишешь тесты, но внезапно оказалось, что часть логики зависит от внешних сервисов. И никак не замокать. Есть выход! Добавь побольше побочных тестов, особенно если они проверяют маловероятные случаи. Тимлид будет доволен и аппрувнет МР.</em></p><p>&ldquo;Уклонистом&rdquo; можно назвать тест, который проверяет маловероятные кейсы, не оказывающие значительное влияние на поведение класса, но при этом как будто бы специально пропускает важные тесткейсы. Пример привести сложно, ведь тут все сильно зависит от бизнеса, для которого работает приложение - бизнес определяет, какие кейсы важные и какие - маловероятные.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/division.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Division</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>a</span>: <span style=color:#66d9ef>number</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>b</span>: <span style=color:#66d9ef>number</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Division by zero!&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>a</span> <span style=color:#f92672>/</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/division.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Division</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/division&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Division&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should divide positive numbers. Returns positive result&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Division</span>(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>result</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>2.5</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should divide one positive and one negative numbers. Returns negative result&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Division</span>(<span style=color:#ae81ff>5</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>result</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>2.5</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should divide two negative numbers. Returns positive result&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Division</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>result</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>2.5</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return cirtuclation fraction&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Division</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>result</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>0.3333333333333333</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>В данном академическом примере мы проверяем тоже важные кейсы, однако один пропустили - кейс деления на ноль. Добавим же его:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/division.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Division</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/division&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Division&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should catch error if we divide by zero&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Division</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>result</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=13-крикун-loudmouth>13. Крикун (Loudmouth)<a hidden class=anchor aria-hidden=true href=#13-крикун-loudmouth>#</a></h2><p><em>Без логов никуда! Код сделал то, что нужно? Пиши в лог об этом. Код зашел в блок if()? Отлично, пиши в лог. А если код зашел в &mldr; else {} &mldr;? Об этом тоже нужно сообщить. Логов много не бывает!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/Boycriedwolfbarlow.jpg alt="Bow cried wolf, 1687"></p><p>Нет, бывает. Тест-крикун выдает слишком много информации, полезной разработчику во время отладки, но точно не во время прогона CI/CD пайплайна. Избавляйтесь от лишних информационных записей, сообщающих лишь то, что все идет по плану - пишите в консоль тогда, когда что-то пошло не так. В обилии информации разработчик может пропустить важную информацию, которая поможет ему понять, что произошло.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/division.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Division</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>a</span>: <span style=color:#66d9ef>number</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>b</span>: <span style=color:#66d9ef>number</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>a</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;a is positive 0&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>a</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;a is negative&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;b is positive&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;b is negative&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;b equals to zero, division by zero error&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Division by zero!&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>a</span> <span style=color:#f92672>/</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Консоль при выполнении тестов класса выше:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Division
</span></span><span style=display:flex><span>    a is positive <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    b is positive
</span></span><span style=display:flex><span>    ✔ should divide positive numbers. Returns positive result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    a is positive <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    b is negative
</span></span><span style=display:flex><span>    ✔ should divide one positive and one negative numbers. Returns negative result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    a is negative
</span></span><span style=display:flex><span>    b is negative
</span></span><span style=display:flex><span>    ✔ should divide two negative numbers. Returns positive result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    a is positive <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    b is positive
</span></span><span style=display:flex><span>    ✔ should <span style=color:#66d9ef>return</span> cirtuclation fraction
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    a is positive <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    b equals to zero, division by zero error
</span></span><span style=display:flex><span>    ✔ should catch error <span style=color:#66d9ef>if</span> we divide by zero
</span></span></code></pre></div><h2 id=14-жадина-greedy-catcher>14. Жадина (Greedy Catcher)<a hidden class=anchor aria-hidden=true href=#14-жадина-greedy-catcher>#</a></h2><p><em>Пишешь тест, проверяющий выпадение ошибки? Просто отлавливай исключения и все. Какая разница, какая ошибка возникла? Она ведь возникла же, а значит тест надежный!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/Krabs_artwork.png alt=Krabs></p><p>Ошибка-то возникла, но где уверенность, что именно та, которую мы ожидаем при определенных условиях? &ldquo;Жадиной&rdquo; можно назвать тест, который отлавливают ошибку, но не проверяет причину ее причину. В примере ниже мы валидируем email, но не проверяем, что именно за ошибка возникла - невалидный email или пустое значение пришло в конструктор.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/email.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Email</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>emailRegex</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>email</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Email cannot be null&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>email</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>get</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>Email</span>.<span style=color:#a6e22e>emailRegex</span>.<span style=color:#a6e22e>test</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Invalid email&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// test/email.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Email</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/email&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Email&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return email for valid cases&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validEmails</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;test@example.com&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;jane.doe@example.co.uk&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;john_doe@example.io&#39;</span>,
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>validEmails</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>email</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Email</span>(<span style=color:#a6e22e>email</span>).<span style=color:#66d9ef>get</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>email</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should throw error for invalid emails&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invalidEmails</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;test@example&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;test@.com&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;test@.com.&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;test@.com.&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;@example.com&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>invalidEmails</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>email</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Email</span>(<span style=color:#a6e22e>email</span>).<span style=color:#66d9ef>get</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Нужно проверять не только факт наличия ошибки, но и удостовериться, что она произошла по ожидаемой причине. Попробуйте проверять не только текст сообщения ошибки, но и тип.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// test/email.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Email</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/email&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Email&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should throw error for null or empty string&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invalidEmails</span> <span style=color:#f92672>=</span> [ <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;&#39;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>invalidEmails</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>email</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Email</span>(<span style=color:#a6e22e>email</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>(<span style=color:#e6db74>&#39;Email cannot be null&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should throw error for invalid emails&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invalidEmails</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;test@example&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;test@.com&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;test@.com.&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;test@.com.&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;@example.com&#39;</span>
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>invalidEmails</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>email</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Email</span>(<span style=color:#a6e22e>email</span>).<span style=color:#66d9ef>get</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>(<span style=color:#e6db74>&#39;Invalid email&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>В JS тоже можно добавить кастомные типы ошибок.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotFoundError</span> <span style=color:#66d9ef>extends</span> Error {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>super</span>(<span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;NotFoundError&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;NotFoundError&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return true for instanceof Error&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NotFoundError</span>(<span style=color:#e6db74>&#39;Not found&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>instanceof</span> Error).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return true for instanceof NotFoundError&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NotFoundError</span>(<span style=color:#e6db74>&#39;Not found&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>NotFoundError</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=15-enumerator-aka-test-with-no-name>15. Enumerator (aka Test With No Name)<a hidden class=anchor aria-hidden=true href=#15-enumerator-aka-test-with-no-name>#</a></h2><p><em>Не трать свой креатив на имена тестов, все равно их никто не читает.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/new_folder_1.png alt="New folder (2)"></p><p>Когда тесткейсов много, а релиз близко, велик соблазн сэкономить время на придумании правильных названий для тестов. В итоге имеем подобное:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Some logic&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return true for valid case 1&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// some arrange for test by the first valid conditions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// some act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// some assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>true</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return true for valid case 2&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// some arrange for test by the second valid conditions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// some act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// some assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>true</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return true for valid case N&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// some arrange for test by the Nth valid conditions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// some act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// some assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>true</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Правильно подобранные имена позволят в будущем быстрее разбираться, почему после рефакторинга тест упал и что нужно исправлять: отрефакторенный код или тесткейс, который не соответствует новым требованиям и условиям.</p><h2 id=16-free-ride-aka-piggyback>16. Free Ride (aka Piggyback)<a hidden class=anchor aria-hidden=true href=#16-free-ride-aka-piggyback>#</a></h2><p><em>Сделал багфикс, отправил на МР, а тимлид говорит, что нужно добавить юниттест? Ну и ладно, не парься, есть же уже написанные тесты. Добавь просто еще один ассерт в существующий тест. Это же легче, чем новый тест-кейс писать.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/star_wars.png alt="Star wars"></p><p>Часто бывает, что класс поменяли незначительно, но новый тест придумывать и писать лень. Поэтому вместо нового тесткейса мы добавляем дополнительный ассерт в один из написанных. Представим ситуацию: у нас есть класс User и тест к нему:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/user.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>firstName</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>lastName</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>isEmailVerified</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>verify</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Email already verified&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isVerified</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/user.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/user&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;User&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should throw an error if we try to verify verified user&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>User</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;john.doe@gmail.com&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;John&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Doe&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>verify</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>(<span style=color:#e6db74>&#39;Email already verified&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Теперь мы добавляем новый метод isSocialEmail:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// ....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>isSocialEmail</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;@facebook.com&#39;</span>) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;@gmail.com&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// ....
</span></span></span></code></pre></div><p>Теперь дополним тесткейс:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should throw an error if we try to verify verified user&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>User</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;john.doe@gmail.com&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;John&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Doe&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>verify</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#66d9ef>throw</span>(<span style=color:#e6db74>&#39;Email already verified&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>isSocialEmail</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Лучше всего будет добавить новый тесткейс, чтобы тесты были независимые и атомарные. В случае, если логика метода verify() сломается и тест будет красным, до проверки isSocialEmail() выполнение даже не дойдет. Получается, что тесткейс на новый функционал не независим и игнорируется в данном случае.</p><h2 id=17-excessive-setup-aka-mother-hen>17. Excessive Setup (aka Mother Hen)<a hidden class=anchor aria-hidden=true href=#17-excessive-setup-aka-mother-hen>#</a></h2><p><em>Настройки, настройки, сетап и еще настройки! Ну и что, что тест-кейс требует миллионы строк настройки условий? Не разделяй код, не рефактори, оставь как есть и бери следующую задачу.</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/homer.jpeg alt="Homer likes setups"></p><p>Тесты, которые требуют много кода для настройки условий, тяжело поддерживать. Иногда фича настолько объемная, что ей нужен такой объем предусловий, но все же это повод задуматься, а не сильно ли много ответственности у класса? А может лучше разделить?</p><p><img loading=lazy src=/images/blog/development/2023-03-04/long_arrange_short_assert.png alt="Long arrange, short assertion"></p><p>В таком тесте тяжело понять суть проверки. Кажется, что настройка слишком &ldquo;шумная&rdquo; и сбивает с толку. Если встретили в своем рабочем проекте подобное, то задумайтесь, не повод ли это отрефакторить класс.</p><h2 id=18-line-hitter>18. Line hitter<a hidden class=anchor aria-hidden=true href=#18-line-hitter>#</a></h2><p><em>Ты тимлид и ты усвоил урок, что стопроцентное покрытие кода - это зло. Ну что ж, в публичных методах мы же можем обеспечить полное покрытие, не так ли?</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/john_wick.jpeg alt="John Wick"></p><p>На первый взгляд, тест в примере ниже покрывает 100% кода метода, однако суть работы особо и не проверяется и выходные данные не анализируются.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/calculator.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Calculator</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>first</span>: <span style=color:#66d9ef>number</span>){}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>second</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>second</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>subtract</span>(<span style=color:#a6e22e>second</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>second</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>multiply</span>(<span style=color:#a6e22e>second</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>second</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>divide</span>(<span style=color:#a6e22e>second</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>second</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// test/calculator.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Calculator</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/calculator&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Calculator&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should call methods&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>add</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Calculator</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>substract</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Calculator</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>subtract</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>multiply</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Calculator</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>multiply</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Calculator</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>divide</span>(<span style=color:#ae81ff>1</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Снова в погоне за метрикой мы упускаем суть тестирования. Метрика - это хорошо, но не самоцель. Сначала напиши тест-кейсы на каждый сценарий, покрой критичный функционал и придуманные пограничные кейсы, а уже потом посмотри на покрытие кода. Если какой-то код остался непокрытым, то может это код нужно удалить, а не тест-кейс добавить?</p><h2 id=19-лжец-aka-evergreen-testshttpsyoutube1z_h55jme-mt1059-success-against-all-odds>19. Лжец (aka <a href="https://youtu.be/1Z_h55jMe-M?t=1059">Evergreen Tests</a>, Success Against All Odds)<a hidden class=anchor aria-hidden=true href=#19-лжец-aka-evergreen-testshttpsyoutube1z_h55jme-mt1059-success-against-all-odds>#</a></h2><p><em>Поменял логику работы метода, но тесты не упали? Отлично, какой ты молодец, что сумел написать такие надежные тесты. Так держать!</em></p><p><img loading=lazy src=/images/blog/development/2023-03-04/liar.png alt=Liar></p><p>&ldquo;Лжецом&rdquo; называют тест, который будет зеленый, даже если код тестируемого метода поменяли. Для демонстрации можно вспомнить один из прошлых примеров:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/user.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>deletedAt</span>: <span style=color:#66d9ef>Date</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>isEmailVerified</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>verify</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Email already verified&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isVerified</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isDeleted</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isSocialEmail</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;@facebook.com&#39;</span>) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;@gmail.com&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>delete</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deletedAt</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;User is already removed&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deletedAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isDeleted</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deletedAt</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// tests/user.test.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;chai&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../src/user&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;User&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;.isVerified should return false if user was removed&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>User</span>(<span style=color:#e6db74>&#39;john.doe@gmail.com&#39;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>.<span style=color:#66d9ef>delete</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>isVerified</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Теперь поменяем проверку в методе isVerified():</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>isVerified</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#75715e>/*!this.isDeleted() &amp;&amp;*/</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEmailVerified</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Тест до сих пор зеленый даже при условии, что код метода был изменен:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;.isVerified should return false if user was removed&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>User</span>(<span style=color:#e6db74>&#39;john.doe@gmail.com&#39;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>target</span>.<span style=color:#66d9ef>delete</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>isVerified</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Все потому, что тест не проверяет подробно состояние тестируемого объекта и не удостоверяется, какие именно условия привели к ожидаемому результату. В качестве решения можно добавить мутационные тесты, которые будут проверять, что тесты не лгут. Мутационный тест - это тест, который меняет или код бизнес-классов, или ассерты в тестах, и проверяет, что тесты упали. Если тесты не упали, то это значит, что доверия к ним нет.</p><h2 id=заключение>Заключение<a hidden class=anchor aria-hidden=true href=#заключение>#</a></h2><p>В этой статье мы рассмотрели 19 антипаттернов в юнит-тестировании. Надеюсь, что теперь ты попадешь в эти ловушки. Код юниттестов - не second-class-citizen, их тоже нужно писать &ldquo;чистыми&rdquo; и понятными. Практикуйся чаще, и тогда код твоего проекта будет надежней, тестировщик будет меньше на тебя ругаться, а тимлид - меньше краснеть.</p><h2 id=источники>Источники<a hidden class=anchor aria-hidden=true href=#источники>#</a></h2><ul><li><a href=https://stackoverflow.com/questions/333682/unit-testing-anti-patterns-catalogue>https://stackoverflow.com/questions/333682/unit-testing-anti-patterns-catalogue</a></li><li><a href=https://archive.is/3acB#selection-119.0-119.17>https://archive.is/3acB#selection-119.0-119.17</a></li><li><a href=https://www.yegor256.com/2018/12/11/unit-testing-anti-patterns.html>https://www.yegor256.com/2018/12/11/unit-testing-anti-patterns.html</a></li><li><a href=https://blog.codepipes.com/testing/software-testing-antipatterns.html>https://blog.codepipes.com/testing/software-testing-antipatterns.html</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://mgorbatyuk.dev/tags/.net/>#.net</a></li><li><a href=https://mgorbatyuk.dev/tags/unit_testing/>#unit_testing</a></li><li><a href=https://mgorbatyuk.dev/tags/testing/>#testing</a></li><li><a href=https://mgorbatyuk.dev/tags/anti_patterns/>#anti_patterns</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Вредные советы по тестированию программ on twitter" href="https://twitter.com/intent/tweet/?text=%d0%92%d1%80%d0%b5%d0%b4%d0%bd%d1%8b%d0%b5%20%d1%81%d0%be%d0%b2%d0%b5%d1%82%d1%8b%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc&url=https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f&hashtags=.net%2cunit_testing%2ctesting%2canti_patterns"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Вредные советы по тестированию программ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f&title=%d0%92%d1%80%d0%b5%d0%b4%d0%bd%d1%8b%d0%b5%20%d1%81%d0%be%d0%b2%d0%b5%d1%82%d1%8b%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc&summary=%d0%92%d1%80%d0%b5%d0%b4%d0%bd%d1%8b%d0%b5%20%d1%81%d0%be%d0%b2%d0%b5%d1%82%d1%8b%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc&source=https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Вредные советы по тестированию программ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f&title=%d0%92%d1%80%d0%b5%d0%b4%d0%bd%d1%8b%d0%b5%20%d1%81%d0%be%d0%b2%d0%b5%d1%82%d1%8b%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Вредные советы по тестированию программ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Вредные советы по тестированию программ on whatsapp" href="https://api.whatsapp.com/send?text=%d0%92%d1%80%d0%b5%d0%b4%d0%bd%d1%8b%d0%b5%20%d1%81%d0%be%d0%b2%d0%b5%d1%82%d1%8b%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc%20-%20https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Вредные советы по тестированию программ on telegram" href="https://telegram.me/share/url?text=%d0%92%d1%80%d0%b5%d0%b4%d0%bd%d1%8b%d0%b5%20%d1%81%d0%be%d0%b2%d0%b5%d1%82%d1%8b%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc&url=https%3a%2f%2fmgorbatyuk.dev%2fblog%2fdevelopment%2f2023-03-04-unit-testing-anti-patterns%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://mgorbatyuk.dev/>mgorbatyuk.dev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
<span><a href=https://github.com/maximgorbatyuk/hugo-blog rel=noopener target=_blank>Hugo source code</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>